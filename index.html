<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Routine Maker - Anwer Khan Modern University</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           GLOBAL STYLES & RESET
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ========================================
           CSS VARIABLES (ROOT)
           Customize colors here
           ======================================== */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --border-color: #000;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ========================================
           BODY & CONTAINER
           ======================================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #000;
            line-height: 1.6;
            padding-top: 70px;  /* Space for fixed header */
        }

        .container {
            max-width: 100%;
            padding: 20px;
        }

        /* ========================================
           FLOATING ACTION BAR (TOP)
           Fixed position header with tabs and buttons
           ======================================== */
        .floating-actions {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 999;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* App logo and title */
        .floating-actions .logo {
            font-weight: 700;
            font-size: 16px;  /* Customize app title size */
            margin-right: 20px;
            color: #008080;   /* Customize app title color */
            font-family: Georgia, serif;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.2;
        }

        /* Copyright text below app title */
        .floating-actions .logo .copyright {
            font-size: 9px;   /* Customize copyright size */
            color: #888;      /* Customize copyright color */
            font-family: 'Segoe UI', sans-serif;
            font-weight: 400;
        }

        /* ========================================
           TAB GROUP (Class Routine, Faculty, Settings)
           ======================================== */
        .tab-group {
            display: flex;
            gap: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 5px;
            border-radius: 10px;
            margin-right: auto;
        }

        .tab {
            padding: 8px 12px;  /* Customize tab padding */
            background: rgba(255, 255, 255, 0.2);
            border: none;
            cursor: pointer;
            font-size: 14px;    /* Customize tab font size */
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 8px;
            color: white;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab.active {
            background: white;
            color: var(--primary-color);
        }

        /* ========================================
           BUTTONS (Save, Load, Export, etc.)
           ======================================== */
        button {
            padding: 10px 20px;  /* Customize button padding */
            border: none;
            background: white;
            cursor: pointer;
            font-size: 14px;     /* Customize button font size */
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        button.primary {
            background: var(--secondary-color);
            color: white;
        }

        button.success {
            background: var(--success-color);
            color: white;
        }

        button.danger {
            background: var(--danger-color);
            color: white;
        }

        /* ========================================
           TAB CONTENT VISIBILITY
           ======================================== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           CLASS ROUTINE TAB - LAYOUT
           ======================================== */
        .routine-container {
            display: flex;
            gap: 0;
        }

        .routine-main {
            flex: 0 0 76%;  /* Changed from 75% to 80% */
            overflow-x: auto;
            padding-right: 20px;
        }

        /* ========================================
           BATCH ROUTINE CARD
           Container for each batch's schedule
           ======================================== */
        .batch-routine {
            margin-bottom: 40px;
            page-break-after: always;
            border: 2px solid var(--border-color);
            padding: 15px;  /* Customize card padding */
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        /* ========================================
           BATCH ROUTINE HEADER
           Contains logo and institution information
           ======================================== */
        .batch-routine-header {
            text-align: center;
            margin-bottom: 5px;
            padding-bottom: 5px;  /* Reduced from 10px to reduce gap */
            /* border-bottom removed */
            display: flex;
            align-items: flex-start;  /* Align to top */
            justify-content: center;
            gap: 10px;
        }

        .batch-routine-header .logo-container {
            flex-shrink: 0;
            display: flex;
            align-items: flex-start;  /* Logo aligns to top */
        }

        /* Logo height - aligns with top 3 lines of header text */
        .batch-routine-header .logo-container img {
            height: 68px;
            width: auto;
            display: block;
            margin-top: -3px;  /* Slight upward adjustment to align with text top */
        }

        .batch-routine-header .header-text {
            flex-shrink: 0;
            text-align: center;
        }

        /* Header text styling - Times New Roman font */
        .batch-routine-header h1 {
            font-size: 20px;
            margin-bottom: 3px;
            line-height: 1.2;
            color: #000;
            font-weight: 700;
            font-family: 'Times New Roman', Times, serif;
        }

        .batch-routine-header h2 {
            font-size: 16px;
            margin-bottom: 3px;
            line-height: 1.2;
            color: #000;
            font-weight: 700;
            font-family: 'Times New Roman', Times, serif;
        }

        .batch-routine-header h3 {
            font-size: 16px;
            color: #000;
            margin-bottom: 8px;
            font-weight: 700;
            line-height: 1.2;
            font-family: 'Times New Roman', Times, serif;
        }

        .batch-routine-header .batch-title {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            display: inline-block;
            border: 1.5px solid #000;
            border-radius: 6px;
            padding: 2px 12px;
        }

        /* ========================================
           ROUTINE TABLE STYLING
           Main schedule table with time slots
           ======================================== */
        .routine-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            table-layout: fixed;  /* Equal column widths */
        }

        .routine-table th,
        .routine-table td {
            border: 1px solid var(--border-color);
            padding: 8px;         /* Customize cell padding */
            text-align: center;
            min-height: 60px;
            font-size: 12px;      /* All cells 12px font */
        }

        /* Table header cells - first row */
        .routine-table th {
            background: #bad3e6;  /* Customize header color */
            font-weight: 800;     /* Bold headers */
            font-size: 12px;      /* Consistent 12px */
        }

        /* Section label (first column) */
        .routine-table .section-label {
            font-weight: 800;     /* Bold section labels */
            background: #bad3e6;  /* Customize section label color */
            font-size: 12px;      /* Consistent 12px */
        }

        /* Room number in first column */
        .room-drop-zone {
            min-height: 20px;
            padding: 2px 6px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 12px;      /* Room numbers 12px */
            font-weight: 800;     /* Bold room numbers */
            transition: all 0.2s;
        }

        /* ========================================
           SECTION & ROOM DROP ZONE
           First column showing section name and room
           ======================================== */
        .section-room {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: center;
            justify-content: center;
        }

        .section-name {
            font-weight: 800;
        }

        

        .room-drop-zone:hover {
            background: #e3f2fd;
        }

        .room-drop-zone.has-room {
            background: transparent;
            border: none;
        }

        /* Room overlap highlighting */
        .room-drop-zone.room-overlap {
            background: #ffebee !important;
            border: 2px solid var(--danger-color) !important;
            border-radius: 4px;
            font-weight: 800;
        }

        /* ========================================
           ROUTINE CELL (Course & Teacher)
           Individual time slot cells
           ======================================== */
        .routine-cell {
            position: relative;
            min-height: 60px;  /* Customize cell minimum height */
            cursor: pointer;
            padding: 4px;      /* Customize cell padding */
        }

        .routine-cell.drop-zone {
            background: #e3f2fd;
        }

        /* Overlap highlighting for cells */
        .routine-cell.overlap {
            background: #ffebee !important;
            border: 2px solid var(--danger-color) !important;
        }

        .cell-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .course-code, .teacher-code {
            font-size: 12px;  /* Customize course/teacher font in cells */
            cursor: pointer;
        }

        .course-code:hover, .teacher-code:hover {
            color: var(--danger-color);
        }

        /* ========================================
           REGULAR ROUTINE TABLE
           4 days √ó 4 time slots structure
           ======================================== */
        .regular-room-header {
            margin: 15px 20px 10px 20px;
        }

        .regular-room-drop-zone {
            display: inline-block;
            min-width: 120px;
            padding: 6px 12px;
            border: 2px dashed #999;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #666;
            cursor: default;
            transition: all 0.2s;
        }

        .regular-room-drop-zone:hover {
            border-color: var(--secondary-color);
            background: #f0f8ff;
        }

        .regular-room-drop-zone.has-room {
            border: none;  /* No border when room assigned */
            background: transparent;
            color: #000;  /* Pure black like Room No. text */
            padding: 6px 0;  /* Adjust padding since no border */
        }

        .regular-routine-table {
            width: calc(100% - 40px);
            margin: 0 20px 20px 20px;
            border-collapse: collapse;
            font-family: 'Nunito', sans-serif;
        }

        .regular-routine-table th {
            background: #bad3e6;
            border: 1px solid var(--border-color);
            padding: 10px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 800;  /* Bold for headers */
            color: #000;
        }

        .regular-routine-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            vertical-align: top;
            min-height: 60px;
        }

        .regular-routine-table .day-column {
            width: 100px;
            font-size: 12px;
            font-weight: 800;  /* Bold for day column header */
        }

        .regular-routine-table .break-column {
            width: 80px;  /* Narrower than other columns */
            background: #f9f9f9 !important;
            pointer-events: none !important;  /* Completely disable all interaction */
            cursor: default !important;
            user-select: none !important;
        }

        .regular-routine-table .break-column-inactive {
            width: 80px !important;
            background: #f9f9f9 !important;
            pointer-events: none !important;
            cursor: default !important;
            user-select: none !important;
        }

        .regular-routine-table .prayer-lunch-col {
            width: 80px !important;
            background: #f9f9f9 !important;
            color: #000 !important;
            font-weight: 700 !important;
            pointer-events: none !important;
            cursor: default !important;
            user-select: none !important;
        }

        .regular-routine-table .day-cell {
            background: #f8f9fa;
            font-weight: 800;  /* Bold for day cells */
            font-size: 12px;
            text-align: center;
        }

        .regular-routine-cell {
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
            font-size: 12px;
            border: 1px solid var(--border-color) !important;  /* Explicit border */
        }

        /* Remove hover effect */
        /* .regular-routine-cell:hover removed */

        .regular-routine-cell .cell-course {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #000;  /* Pure black */
            margin-bottom: 2px;
        }

        .regular-routine-cell .cell-teacher {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #000;  /* Pure black - same as course */
            margin-bottom: 2px;
        }

        .regular-routine-cell .cell-room {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #000;  /* Pure black - same as others */
            /* No italic */
        }

        /* Hover effects for regular routine cell items */
        .regular-routine-cell .cell-course:hover,
        .regular-routine-cell .cell-teacher:hover,
        .regular-routine-cell .cell-room:hover {
            color: var(--danger-color);  /* Red color on hover, same as diploma */
        }

        /* Overlap highlighting for regular routine cells */
        .regular-routine-cell.overlap {
            background: #ffebee !important;
            border: 2px solid var(--danger-color) !important;
        }

        .break-cell {
            background: #f9f9f9;
            color: #999;
            font-size: 12px;
            vertical-align: middle;  /* Center vertically */
            text-align: center;
        }

        /* ========================================
           TEACHER/FACULTY INFO BOX
           Contact information below each batch
           ======================================== */
        .teacher-info-box {
            border: 1px solid var(--border-color);
            padding: 10px;
            font-size: 10px;  /* Customize teacher info font size */
            background: #f9f9f9;
            border-radius: 8px;
            margin: 0 20px;   /* Match table left/right margin (20px) */
        }

        .teacher-info-box h4 {
            margin-bottom: 8px;
            font-size: 12px;
        }

        .teacher-info-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        /* ========================================
           SIDEBAR (RIGHT SIDE)
           Resources list - courses, teachers, rooms
           ======================================== */
        .sidebar {
            width: 24%;           /* Changed from 25% to 20% */
            flex: 0 0 24%;
            background: white;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            position: sticky;
            top: 90px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 0;
        }

        .sidebar h3 {
            margin: 0;
            padding: 15px;
            font-size: 14px;  /* Customize sidebar heading size */
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #ddd;
        }

        /* Sidebar header with batch type tabs */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0;
            padding: 12px 15px;
            font-size: 14px;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #ddd;
        }

        .sidebar-header h3 {
            margin: 0;
            padding: 0;
            background: transparent;
            border: none;
            font-size: 14px;
        }

        .batch-type-tabs {
            display: flex;
            gap: 5px;
            background: #e0e0e0;
            padding: 3px;
            border-radius: 5px;
        }

        .batch-type-tab {
            padding: 6px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;  /* Match Resources title font size */
            font-weight: 600;
            border-radius: 4px;
            color: #666;
            transition: all 0.2s;
        }

        .batch-type-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .batch-type-tab:hover {
            color: var(--primary-color);
        }

        .sidebar-section {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-section h3 {
            background: transparent;
            border: none;
            padding: 0;
            margin-bottom: 10px;
            border-radius: 0;
        }

        /* ========================================
           SEMESTER TABS (1st, 2nd, 3rd, etc.)
           Tab switcher for course semesters
           ======================================== */
        .semester-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .semester-tab {
            padding: 8px;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 12px;  /* Customize semester tab font size */
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
            text-align: center;
            border: none;
        }

        .semester-tab:hover {
            background: #e3f2fd;
            color: var(--secondary-color);
        }

        .semester-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* ========================================
           DRAGGABLE ITEMS (Courses, Teachers, Rooms)
           Items that can be dragged into schedule
           ======================================== */
        .draggable-items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .draggable-items-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .draggable-item {
            padding: 8px;
            background: #f8f9fa;
            cursor: move;
            font-size: 12px;  /* Customize draggable item font size */
            font-weight: 600;
            transition: all 0.2s;
            border-radius: 6px;
            text-align: center;
            position: relative;
            border: none;
        }

        .draggable-item:hover {
            background: #e3f2fd;
            color: var(--secondary-color);
        }

        .draggable-item.dragging {
            opacity: 0.5;
        }

        /* Tooltip on hover (course titles) */
        .draggable-item[data-title]:hover::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: wrap;
            z-index: 1000;
            margin-bottom: 5px;
            pointer-events: none;
        }

        /* Teacher item with assignment count */
        .teacher-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            gap: 8px;
        }

        .teacher-count {
            background: var(--secondary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            min-width: 25px;
            text-align: center;
        }

        /* ========================================
           SETTINGS TAB - BATCH CONFIGURATION
           Configure semester name and batch details
           ======================================== */
        .info-container {
            max-width: 100%;
            overflow-x: auto;
        }

        .batch-config {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .batch-config h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        /* Batch Config Header with Tabs */
        .batch-config-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .batch-config-header h3 {
            margin: 0;
        }

        .batch-config-tabs {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            padding: 3px;
            border-radius: 6px;
        }

        .batch-config-tab {
            padding: 6px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
            color: #666;
            transition: all 0.2s;
        }

        .batch-config-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .batch-config-tab:hover {
            color: var(--primary-color);
        }

        .batch-config-content {
            display: none;
        }

        .batch-config-content.active {
            display: block;
        }

        /* Semester name input field */
        .semester-input-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .semester-input-group label {
            font-weight: 600;
            font-size: 14px;  /* Customize semester label size */
        }

        .semester-input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;  /* Customize semester input size */
            min-width: 200px;
        }

        /* Batch inputs grid (8 batches) */
        .batch-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
        }

        .batch-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .batch-input-group label {
            font-weight: 600;
            font-size: 12px;  /* Customize batch label size */
        }

        .batch-input-group input,
        .batch-input-group select {
            padding: 6px;
            border: 1px solid #ddd;
            font-size: 12px;  /* Customize batch input size */
            border-radius: 6px;
            transition: all 0.2s;
        }

        /* ========================================
           SETTINGS TAB - INFO COLUMNS
           Three vertical cards for Courses, Faculty, and Rooms
           ======================================== */
        .info-columns {
            display: flex;
            gap: 10px;
            max-width: 100%;
        }

        .info-column {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            min-width: 0;
        }

        /* Courses card - 42% width */
        .info-column:nth-child(1) {
            flex: 0 0 calc(42% - 7px);
        }

        /* Faculty card - 42% width */
        .info-column:nth-child(2) {
            flex: 0 0 calc(42% - 7px);
        }

        /* Rooms card - 16% width */
        .info-column:nth-child(3) {
            flex: 0 0 calc(16% - 6px);
            padding: 15px 6px;
        }

        /* Room column header - match font size with other columns */
        .info-column:nth-child(3) h3 {
            font-size: 16px;  /* Match Courses and Faculty font size */
            margin-bottom: 15px;
        }

        /* Room column add button - match other add buttons */
        .info-column:nth-child(3) .add-btn {
            font-size: 12px;   /* Match other add buttons */
            padding: 10px 15px;  /* Match other add buttons */
        }

        /* ========================================
           STANDARDIZED INPUT HEIGHTS
           All inputs across three cards have same height
           ======================================== */
        .info-item input {
            padding: 8px 6px;  /* Consistent padding for uniform height */
            border: 1px solid #ddd;
            font-size: 12px;   /* Consistent 12px font */
            border-radius: 6px;
            transition: all 0.2s;
            width: 100%;
            min-width: 0;
            height: 36px;      /* Fixed height for consistency */
            box-sizing: border-box;
        }

        /* Course item grid - code, title, credits, delete */
        .info-item.course-item {
            display: grid;
            grid-template-columns: 1fr 2fr 0.7fr auto;
            gap: 5px;
        }

        /* Delete buttons - consistent height with inputs */
        .delete-btn {
            padding: 8px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;   /* Larger font for X/√ó */
            font-weight: 700;  /* Bold X */
            border-radius: 6px;
            transition: all 0.2s;
            height: 36px;      /* Match input height */
            box-sizing: border-box;
        }

        .info-column h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--primary-color);
        }


        .semester-section {
            margin-bottom: 20px;
        }

        .semester-section h4 {
            font-size: 13px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-left: 3px solid var(--secondary-color);
            border-radius: 4px;
        }

        .info-list {
            list-style: none;
        }

        .info-item {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            align-items: center;
        }


        /* Teacher item container */
        .info-item.teacher-item-input {
            display: flex;
            flex-direction: column;
            padding: 12px;
            border: 1px solid #ddd;
            background: #fafafa;
            margin-bottom: 10px;
            border-radius: 8px;
            gap: 8px;
        }

        /* Teacher inputs grid - name, short, phone */
        .teacher-inputs {
            display: grid;
            grid-template-columns: 2fr .75fr 1.5fr;
            gap: 8px;
        }

        /* All teacher inputs - 12px font, consistent height */
        .teacher-inputs input {
            font-size: 12px;
            height: 36px;
            padding: 8px 6px;
        }

        /* Teacher delete row */
        .teacher-delete-row {
            display: flex;
            justify-content: center;
		width: 100%;
        }

        /* Teacher delete button - full width, 12px font */
        .teacher-delete-row .delete-btn {
            width: 100%;
            font-size: 12px;
            height: 36px;
        }

       
        .delete-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .add-btn {
            margin-top: 10px;
            padding: 10px 15px;
            background: var(--success-color);
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .add-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Faculty Schedule */
        .teachers-schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-bottom: 20px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            background: white;
            box-shadow: var(--card-shadow);
        }

        .teachers-schedule-table th,
        .teachers-schedule-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            color: #000;
            font-size: 12px;      /* All cells 12px */
        }

        .teachers-schedule-table th {
            background: #fcdb9a;  /* Custom light peach color for faculty schedule */
            font-weight: 800;
            font-size: 12px;
        }

        .teachers-schedule-table .teacher-name-cell {
            font-weight: 800;
            background: #fcdb9a;  /* Custom light peach color for faculty schedule */
            text-align: left;
            width: 200px;
            max-width: 200px;
            font-size: 12px;
        }

        /* ========================================
           COURSE DISTRIBUTION TABLE
           ======================================== */
        .course-distribution-card {
            margin-bottom: 40px;
            border: 2px solid var(--border-color);
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .course-distribution-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-family: 'Nunito', sans-serif;
        }

        .course-distribution-table th {
            background: #cbe0b1;  /* Header color from doc */
            font-size: 12px;
            font-weight: 800;
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            color: #000;
        }

        .course-distribution-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            font-size: 12px;
            font-weight: 700;
            color: #000;
        }

        .course-distribution-table .sl-no {
            text-align: center;
            width: 60px;
        }

        .course-distribution-table .faculty-name {
            text-align: left;
            width: 180px;
        }

        .course-distribution-table .course-info {
            text-align: left;
        }

        .course-distribution-table .batch-section {
            text-align: center;
            width: 120px;
        }

        .course-distribution-table .credits {
            text-align: center;
            width: 80px;
        }

        .course-distribution-table .total-credits {
            text-align: center;
            width: 100px;
            font-weight: 800;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .toast.error {
            background: var(--danger-color);
        }

        .toast.success {
            background: var(--success-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 800px) {
            .info-columns {
                flex-direction: column;
            }

            .info-column:nth-child(1),
            .info-column:nth-child(2),
            .info-column:nth-child(3) {
                flex: 1 1 auto;
                padding: 15px;
            }

            .batch-inputs {
                grid-template-columns: repeat(2, 1fr);
            }

            .routine-container {
                flex-direction: column;
            }

            .routine-main {
                flex: 1 1 auto;
                width: 100%;
                padding-right: 10;
            }

            .sidebar {
                width: 100%;
                flex: 1 1 auto;
                max-height: 50vh;
                position: static;
                margin-top: 20px;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                padding-top: 0;
            }

            .floating-actions,
            .sidebar,
            button {
                display: none !important;
            }

            .routine-container {
                display: block;
            }

            .routine-main {
                width: 100%;
            }

            .batch-routine {
                page-break-after: always;
                border: none !important;  /* No border when printing */
                box-shadow: none;
            }

            .routine-table th {
                background: #bad3e6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .routine-table .section-label {
                background: #bad3e6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .regular-routine-table th {
                background: #bad3e6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .regular-routine-table .day-cell {
                background: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .regular-routine-table .break-column,
            .regular-routine-table .break-column-inactive,
            .regular-routine-table .prayer-lunch-col {
                background: #f9f9f9 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .regular-room-drop-zone {
                border: none !important;  /* No border when printing */
            }

            .teachers-schedule-table th,
            .teachers-schedule-table .teacher-name-cell {
                background: #fcdb9a !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .course-distribution-table th {
                background: #cbe0b1 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .course-distribution-card {
                border: none !important;
            }

            .routine-cell.overlap {
                background: white !important;
                border: 1px solid black !important;
            }

            .tab-content {
                display: none !important;
            }

            .tab-content.active {
                display: block !important;
            }
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="floating-actions">
        <span class="logo">
            Class Routine Maker
            <span class="copyright">---MTG---</span>
        </span>
        <div class="tab-group">
            <div class="tab active" onclick="app.switchTab(0)">Class Routine</div>
            <div class="tab" onclick="app.switchTab(1)">Faculty Schedule</div>
            <div class="tab" onclick="app.switchTab(2)">Course Distribution</div>
            <div class="tab" onclick="app.switchTab(3)">Settings</div>
        </div>
        <button class="success" onclick="app.checkOverlap()">‚úì Check</button>
        <button class="primary" onclick="app.saveData()">üíæ Save</button>
        <button class="primary" onclick="app.loadData()">üìÇ Load</button>
        <button onclick="app.exportToPDF()">üñ®Ô∏è Export PDF</button>
        <button class="danger" onclick="app.clearAll()">üóëÔ∏è Clear All</button>
    </div>

    <div class="container">
        <!-- Tab 1: Class Routine -->
        <div class="tab-content active" id="tab-class-routine">
            <div class="routine-container">
                <div class="routine-main" id="routine-main"></div>

                <div class="sidebar">
                    <div class="sidebar-header">
                        <h3>üìã Resources</h3>
                        <div class="batch-type-tabs">
                            <button class="batch-type-tab active" onclick="app.switchBatchType('diploma')">Dip</button>
                            <button class="batch-type-tab" onclick="app.switchBatchType('regular')">Reg</button>
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <h3>üìö Courses</h3>
                        <div class="semester-tabs" id="semester-tabs"></div>
                        <div id="course-codes-list" class="draggable-items-grid"></div>
                    </div>

                    <div class="sidebar-section">
                        <h3>üéì Faculty Members</h3>
                        <div id="teachers-list" class="draggable-items-list"></div>
                    </div>

                    <div class="sidebar-section">
                        <h3>üè´ Room Numbers</h3>
                        <div id="rooms-list" class="draggable-items-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Faculty Schedule -->
        <div class="tab-content" id="tab-teachers-schedule">
            <div id="teachers-schedule-container"></div>
        </div>

        <!-- Tab 3: Course Distribution -->
        <div class="tab-content" id="tab-course-distribution">
            <div id="course-distribution-container"></div>
        </div>

        <!-- Tab 4: Settings -->
        <div class="tab-content" id="tab-info">
            <div class="info-container">
                <div class="batch-config">
                    <div class="batch-config-header">
                        <h3>‚öôÔ∏è Batch Configuration</h3>
                        <div class="batch-config-tabs">
                            <button class="batch-config-tab active" onclick="app.switchBatchConfigTab('diploma')">Diploma</button>
                            <button class="batch-config-tab" onclick="app.switchBatchConfigTab('regular')">Regular</button>
                        </div>
                    </div>
                    
                    <!-- Diploma Batch Configuration -->
                    <div class="batch-config-content active" id="diploma-batch-config">
                        <div class="semester-input-group">
                            <label>Semester:</label>
                            <input type="text" id="semester-name-input" placeholder="e.g., Fall 2025">
                        </div>
                        <div class="batch-inputs" id="batch-config-inputs"></div>
                        <button class="primary" style="margin-top: 15px;" onclick="app.applyBatchConfig()">Apply Configuration</button>
                    </div>
                    
                    <!-- Regular Batch Configuration -->
                    <div class="batch-config-content" id="regular-batch-config">
                        <div class="semester-input-group">
                            <label>Semester:</label>
                            <input type="text" id="regular-semester-name-input" placeholder="e.g., Fall 2025" disabled style="background: #f5f5f5;">
                            <small style="color: #666; margin-left: 10px;">(Same as Diploma semester)</small>
                        </div>
                        <div class="batch-inputs" id="regular-batch-config-inputs"></div>
                        <button class="primary" style="margin-top: 15px;" onclick="app.applyRegularBatchConfig()">Apply Configuration</button>
                    </div>
                </div>

                <div class="info-columns">
                    <div class="info-column">
                        <h3>üìö Courses</h3>
                        <div id="course-codes-info"></div>
                    </div>

                    <div class="info-column">
                        <h3>üéì Faculty Members</h3>
                        <div id="teachers-info"></div>
                        <button class="add-btn" onclick="app.addTeacher()">+ Add Faculty</button>
                    </div>

                    <div class="info-column">
                        <h3>üè´ Room Numbers</h3>
                        <div id="rooms-info">
                            <ul class="info-list" id="rooms-list-info"></ul>
                        </div>
                        <button class="add-btn" onclick="app.addRoom()">+ Add Room</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            data: {
                semesterName: 'Fall 2025',
                // Diploma batches (existing)
                diplomaBatches: [
                    { name: '1st', sections: 8, shift: 'morning' },
                    { name: '2nd', sections: 4, shift: 'afternoon' },
                    { name: '3rd', sections: 4, shift: 'morning' },
                    { name: '4th', sections: 3, shift: 'afternoon' },
                    { name: '5th', sections: 3, shift: 'afternoon' },
                    { name: '6th', sections: 3, shift: 'afternoon' },
                    { name: '7th', sections: 3, shift: 'morning' },
                    { name: '8th', sections: 3, shift: 'morning' }
                ],
                // Regular batches (new - only 1 section each)
                regularBatches: [
                    { name: '1st' },
                    { name: '2nd' },
                    { name: '3rd' },
                    { name: '4th' },
                    { name: '5th' },
                    { name: '6th' },
                    { name: '7th' },
                    { name: '8th' }
                ],
                // Backward compatibility
                batches: [
                    { name: '1st', sections: 8, shift: 'morning' },
                    { name: '2nd', sections: 4, shift: 'afternoon' },
                    { name: '3rd', sections: 4, shift: 'morning' },
                    { name: '4th', sections: 3, shift: 'afternoon' },
                    { name: '5th', sections: 3, shift: 'afternoon' },
                    { name: '6th', sections: 3, shift: 'afternoon' },
                    { name: '7th', sections: 3, shift: 'morning' },
                    { name: '8th', sections: 3, shift: 'morning' }
                ],
                courses: {
                    1: [
                        { code: 'CHE 1101', title: 'Chemistry', credits: '3' },
                        { code: 'PHY 1101', title: 'Physics', credits: '3' },
                        { code: 'HUM 1101', title: 'Bangladesh Studies', credits: '3' },
                        { code: 'MAT 1101', title: 'MATH-I (Differential & Integral Calculus)', credits: '3' },
                        { code: 'MEC 1101', title: 'Basic Mechanical Engineering', credits: '3' },
                        { code: 'CHE 1102', title: 'Chemistry Lab', credits: '0.75' },
                        { code: 'PHY 1102', title: 'Physics Lab', credits: '0.75' },
                        { code: 'MEC 1102', title: 'Basic Mechanical Engineering Lab', credits: '0.75' },
			{ code: 'MEC 1100', title: 'Mechanical Engineering Drawing-I', credits: '1.5' },
			{ code: 'MEC 1104', title: 'Shop Practice', credits: '1.5' }
		    ],
                    2: [
    			{ code: 'MEC 1201', title: 'Production Process', credits: '3' },
    			{ code: 'CSE 1201', title: 'Computer Fundamentals & Programming Techniques', credits: '3' },
    			{ code: 'HUM 1201', title: 'Fundamentals of English (Reading and Writing)', credits: '3' },
    			{ code: 'MAT 1201', title: 'MATH-II (Ordinary and Partial Differential Equations)', credits: '3' },
    			{ code: 'EEE 1201', title: 'Basic Electrical Engineering', credits: '3' },
    			{ code: 'MEC 1202', title: 'Production Process Lab', credits: '1.5' },
    			{ code: 'CSE 1202', title: 'Computer Fundamentals and Programming Techniques Lab', credits: '1.5' },
    			{ code: 'EEE 1202', title: 'Basic Electrical Engineering Lab', credits: '1.5' }
		    ],

                    3: [
    			{ code: 'MAT 2101', title: 'MATH-III (Linear Algebra and Coordinate Geometry)', credits: '3' },
    			{ code: 'HUM 2101', title: 'Accounting and Financial Management', credits: '3' },
    			{ code: 'MEC 2101', title: 'Basic Thermodynamics', credits: '3' },
    			{ code: 'MEC 2103', title: 'Engineering Mechanics-I', credits: '3' },
    			{ code: 'MEC 2105', title: 'Metallic Materials Science', credits: '4' },
    			{ code: 'MEC 2102', title: 'Thermodynamics Lab', credits: '1.5' },
    			{ code: 'MEC 2106', title: 'Metallic Materials Science Lab', credits: '0.75' },
    			{ code: 'MEC 2104', title: 'Engineering Mechanics-I Lab', credits: '0.75' },
    			{ code: 'MEC 2100', title: 'Mechanical Engineering Drawing-II', credits: '1.5' }
		    ],

                    4: [
    			{ code: 'MAT 2201', title: 'MATH-IV (Complex Variable and Special Functions)', credits: '3' },
    			{ code: 'MEC 2201', title: 'Mechanics of Solids', credits: '4' },
    			{ code: 'EEE 2201', title: 'Electrical Machines and Electronics', credits: '3' },
    			{ code: 'MEC 2203', title: 'Engineering Mechanics-II', credits: '3' },
    			{ code: 'MEC 2205', title: 'Instrumentation and Industrial Automation', credits: '3' },
    			{ code: 'EEE 2202', title: 'Electrical Machines and Electronics Lab', credits: '1.5' },
    			{ code: 'MEC 2204', title: 'Engineering Mechanics-II Lab', credits: '0.75' },
    			{ code: 'MEC 2206', title: 'Instrumentation and Automation Lab', credits: '0.75' },
    			{ code: 'MEC 2202', title: 'Mechanics of Solids Lab', credits: '1.5' }
		    ],

                    5: [
    			{ code: 'MAT 3101', title: 'MATH-V (Numerical Analysis and Statistics)', credits: '3' },
    			{ code: 'MEC 3101', title: 'Fluid Mechanics-I', credits: '3' },
    			{ code: 'MEC 3103', title: 'Heat & Mass Transfer', credits: '3' },
    			{ code: 'MEC 3105', title: 'Basic Mechatronics', credits: '3' },
    			{ code: 'MEC 3107', title: 'Design of Machine Elements-I', credits: '3' },
    			{ code: 'MAT 3102', title: 'MATH-V (Numerical Analysis and Statistics Lab)', credits: '1.5' },
    			{ code: 'MEC 3102', title: 'Fluid Mechanics-I Lab', credits: '1.5' },
    			{ code: 'MEC 3104', title: 'Heat & Mass Transfer Lab', credits: '1.5' },
    			{ code: 'MEC 3108', title: 'Design of Machine Elements-I Lab', credits: '0.75' }
		    ],

                    6: [
    			{ code: 'MEC 3201', title: 'Production Planning and Control', credits: '3' },
    			{ code: 'MEC 3203', title: 'Engineering Mechanics-III', credits: '3' },
    			{ code: 'MEC 3205', title: 'Refrigeration and Air Conditioning', credits: '3' },
    			{ code: 'MEC 3207', title: 'Design of Machine Elements-II', credits: '3' },
    			{ code: 'MEC 3209', title: 'Fluid Mechanics-II', credits: '3' },
    			{ code: 'MEC 3204', title: 'Engineering Mechanics-III Lab', credits: '0.75' },
    			{ code: 'MEC 3208', title: 'Design of Machine Elements-II Lab', credits: '1.5' },
    			{ code: 'MEC 3210', title: 'Fluid Mechanics-II Lab', credits: '1.5' }
		    ],

                    7: [
    			{ code: 'MEC 4101', title: 'Industrial Management', credits: '3' },
    			{ code: 'MEC 4103', title: 'Applied Thermodynamics', credits: '3' },
    			{ code: 'MEC 4105', title: 'Measurement, Quality Control and Materials Handling', credits: '3' },
    			{ code: 'MEC 4107', title: 'Power Plant Engineering', credits: '3' },
    			{ code: 'MEC 41**', title: 'Optional-I', credits: '3' },
    			{ code: 'MEC 4104', title: 'Applied Thermodynamics Lab', credits: '0.75' },
    			{ code: 'MEC 4106', title: 'Measurement, Quality Control and Materials Handling Lab', credits: '1.5' },
    			{ code: 'MEC 4100', title: 'Project and Thesis', credits: '3' }
		     ],

                    8: [
    			{ code: 'ME 4201', title: 'Machine Tools and Tool Engineering', credits: '3' },
    			{ code: 'MEC 4203', title: 'Fluid Machinery', credits: '3' },
    			{ code: 'MEC 4205', title: 'Machine Tools', credits: '3' },
    			{ code: 'MEC 42**', title: 'Optional-II', credits: '3' },
    			{ code: 'MEC 4204', title: 'Fluid Machinery Lab', credits: '1.5' },
    			{ code: 'MEC 4206', title: 'Machine Tools Lab', credits: '1.5' },
    			{ code: 'MEC 4200', title: 'Project and Thesis', credits: '3' }
		      ]
                },
                teachers: [
                    { name: 'Md. Rafiqul Islam', short: 'RI', phone: '01818474146' },
                    { name: 'Md. Shahriar Faisal', short: 'SF', phone: '01726261262' },
                    { name: 'Tamanna Rahman', short: 'TR', phone: '01795040109' },
                    { name: 'Muhammad Taharat Galib', short: 'TG', phone: '01521202012' },
                    { name: 'Nihon Rabbani', short: 'NR', phone: '01799445702' },
                    { name: 'Md. Shamim Ali', short: 'MSA', phone: '01784608495' },
                    { name: 'Omar Faruk', short: 'OF', phone: '01887820983' },
                    { name: 'Md. Arafat Shahriar', short: 'MAS', phone: '01753281215' },
                    { name: 'Tasnuva Islam', short: 'TI', phone: '01521735621' },
                    { name: 'Arpita Sengupta', short: 'ASG', phone: '01813879988' },
                    { name: 'Chinmoy Dev Nath', short: 'CDN', phone: '01783228682' },
                    { name: 'Jahid Hassan', short: 'JH', phone: '01521457408' },
                    { name: 'Umme Habiba', short: 'UH', phone: '01959244550' },
                    { name: 'Shakila Zahan', short: 'SZ', phone: '01780829093' },
                    { name: 'Md Ashikul Alam', short: 'MAA', phone: '01521565671' },
                    { name: 'Ummul Khayer Fatema', short: 'UKF', phone: '01719025333' },
                    { name: 'Mehbub-A-Kabir', short: 'MAK', phone: '01738252554' },
                    { name: 'Nusrat Jahan Imu', short: 'NJI', phone: '01783601318' },
                    { name: 'Pinky Akter', short: 'PA', phone: '01643916550' },
                    { name: 'Mustakim Howlader', short: 'MH', phone: '01960608743' },
                    { name: 'Md. Redowanul Hasan', short: 'RH', phone: '01766888939' },
                    { name: 'Abdullah-Al-Ahad', short: 'AAA', phone: '01937460570' },
                    { name: 'Muhammad Imtiaz Hossain', short: 'MIH', phone: '01720106670' },
                    { name: 'Shabnam Shireen', short: 'SS', phone: '01746037296' },
                    { name: 'Mohammad Ismail', short: 'MI', phone: '01886006867' },
                    { name: 'Mithun Chandra Sarker', short: 'MCS', phone: '01521109663' }
                ],
                rooms: ['1301', '1302', '2301', '2302', '3301', '3302', '4301', '4302', '5301', '5302', '6301', '6302', '7301', '7302', '8301', '8302'],
                sectionRooms: {},
                // Diploma time slots (existing - Friday/Saturday)
                timeSlots: {
                    friday: {
                        morning: [
                            { start: '09:00AM', end: '09:50AM' },
                            { start: '09:50AM', end: '10:40AM' },
                            { start: '10:40AM', end: '11:30AM' },
                            { start: '11:30AM', end: '12:20PM' },
                            { start: '12:20PM', end: '01:10PM' }
                        ],
                        afternoon: [
                            { start: '02:30PM', end: '03:20PM' },
                            { start: '03:20PM', end: '04:10PM' },
                            { start: '04:10PM', end: '05:00PM' },
                            { start: '05:00PM', end: '05:50PM' },
                            { start: '05:50PM', end: '06:40PM' }
                        ]
                    },
                    saturday: [
                        { start: '09:00AM', end: '10:00AM' },
                        { start: '10:00AM', end: '11:00AM' },
                        { start: '11:00AM', end: '12:00PM' },
                        { start: '12:00PM', end: '01:00PM' }
                    ]
                },
                // Regular time slots (new - 4 days with 4 time slots each)
                regularTimeSlots: {
                    days: ['Saturday', 'Sunday', 'Monday', 'Thursday'],
                    slots: [
                        { start: '09:30AM', end: '10:45AM' },
                        { start: '10:45AM', end: '12:00PM' },
                        { start: '12:00PM', end: '01:15PM' },
                        { start: '02:00PM', end: '04:00PM' }
                    ]
                },
                routine: {},  // Diploma routine
                regularRoutine: {},  // Regular routine
                regularBatchRooms: {},  // Room assignments for regular batches
                // Tracking which system is active
                activeBatchType: 'diploma',  // 'diploma' or 'regular'
                activeBatchConfigTab: 'diploma',  // For settings tab
                currentSemester: 1
            },

            init() {
                this.loadFromLocalStorage();
                this.initRoutine();
                this.initRegularRoutine();
                this.renderBatchConfig();
                this.renderInfoTab();
                this.syncBatchTypeTabs();  // Sync Dip/Reg tabs with activeBatchType
                this.renderRoutines();
                this.renderSidebar();
                this.renderTeachersSchedule();
                this.setupDragAndDrop();
            },

            syncBatchTypeTabs() {
                // Sync the Dip/Reg tab button states with activeBatchType
                const tabs = document.querySelectorAll('.batch-type-tab');
                tabs.forEach(tab => {
                    tab.classList.remove('active');
                    const tabText = tab.textContent.toLowerCase();
                    if ((tabText === 'dip' && this.data.activeBatchType === 'diploma') ||
                        (tabText === 'reg' && this.data.activeBatchType === 'regular')) {
                        tab.classList.add('active');
                    }
                });
            },

            loadFromLocalStorage() {
                const saved = localStorage.getItem('classRoutineData');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.data = { ...this.data, ...data };
                        // Ensure activeBatchType defaults to 'diploma' if not present
                        if (!this.data.activeBatchType) {
                            this.data.activeBatchType = 'diploma';
                        }
                    } catch (error) {
                        console.error('Error loading from localStorage:', error);
                    }
                }
            },

            autoSave() {
                const data = {
                    semesterName: this.data.semesterName,
                    batches: this.data.batches,
                    diplomaBatches: this.data.diplomaBatches,
                    regularBatches: this.data.regularBatches,
                    courses: this.data.courses,
                    teachers: this.data.teachers,
                    rooms: this.data.rooms,
                    routine: this.data.routine,
                    regularRoutine: this.data.regularRoutine,
                    sectionRooms: this.data.sectionRooms,
                    regularBatchRooms: this.data.regularBatchRooms,
                    timeSlots: this.data.timeSlots,
                    regularTimeSlots: this.data.regularTimeSlots,
                    activeBatchType: this.data.activeBatchType,
                    activeBatchConfigTab: this.data.activeBatchConfigTab
                };
                localStorage.setItem('classRoutineData', JSON.stringify(data));
            },

            initRoutine() {
                this.data.batches.forEach(batch => {
                    const sections = this.getSectionLetters(batch.sections);
                    sections.forEach(section => {
                        const key = `${batch.name}-${section}`;
                        if (!this.data.routine[key]) {
                            this.data.routine[key] = {
                                friday: Array(5).fill(null).map(() => ({ course: '', teacher: '' })),
                                saturday: Array(4).fill(null).map(() => ({ course: '', teacher: '' }))
                            };
                        }
                        if (!this.data.sectionRooms[key]) {
                            this.data.sectionRooms[key] = '';
                        }
                    });
                });
            },

            initRegularRoutine() {
                this.data.regularBatches.forEach(batch => {
                    const key = batch.name;  // No sections for regular
                    if (!this.data.regularRoutine[key]) {
                        // 4 days √ó 4 time slots
                        this.data.regularRoutine[key] = {
                            Saturday: Array(4).fill(null).map(() => ({ course: '', teacher: '', room: '' })),
                            Sunday: Array(4).fill(null).map(() => ({ course: '', teacher: '', room: '' })),
                            Monday: Array(4).fill(null).map(() => ({ course: '', teacher: '', room: '' })),
                            Thursday: Array(4).fill(null).map(() => ({ course: '', teacher: '', room: '' }))
                        };
                    }
                    if (!this.data.regularBatchRooms[key]) {
                        this.data.regularBatchRooms[key] = '';
                    }
                });
            },

            getSectionLetters(count) {
                return Array.from({ length: count }, (_, i) => String.fromCharCode(65 + i));
            },

            switchTab(index) {
                const tabs = document.querySelectorAll('.tab');
                const contents = document.querySelectorAll('.tab-content');
                
                tabs.forEach((tab, i) => {
                    tab.classList.toggle('active', i === index);
                });
                
                contents.forEach((content, i) => {
                    content.classList.toggle('active', i === index);
                });

                if (index === 1) {
                    this.renderTeachersSchedule();
                } else if (index === 2) {
                    this.renderCourseDistribution();
                }
            },

            switchBatchConfigTab(type) {
                // Update active batch config tab
                this.data.activeBatchConfigTab = type;
                
                // Update tab button styles
                const tabs = document.querySelectorAll('.batch-config-tab');
                tabs.forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                
                // Show/hide config content
                document.getElementById('diploma-batch-config').classList.toggle('active', type === 'diploma');
                document.getElementById('regular-batch-config').classList.toggle('active', type === 'regular');
                
                // Sync semester name for regular
                if (type === 'regular') {
                    document.getElementById('regular-semester-name-input').value = this.data.semesterName;
                }
            },

            renderBatchConfig() {
                // Render Diploma batch configuration
                const semesterInput = document.getElementById('semester-name-input');
                if (semesterInput) {
                    semesterInput.value = this.data.semesterName;
                    semesterInput.onchange = (e) => {
                        this.data.semesterName = e.target.value;
                        // Sync to regular semester input
                        const regularInput = document.getElementById('regular-semester-name-input');
                        if (regularInput) regularInput.value = e.target.value;
                        this.renderRoutines();
                        this.autoSave();
                    };
                }

                const container = document.getElementById('batch-config-inputs');
                container.innerHTML = '';

                this.data.diplomaBatches.forEach((batch, index) => {
                    const batchDiv = document.createElement('div');
                    batchDiv.className = 'batch-input-group';
                    batchDiv.innerHTML = `
                        <label>Batch ${index + 1}</label>
                        <input type="text" value="${batch.name}" onchange="app.updateDiplomaBatchName(${index}, this.value)" placeholder="Name">
                        <select onchange="app.updateDiplomaBatchSections(${index}, this.value)">
                            ${Array.from({ length: 10 }, (_, i) => i + 1).map(num => 
                                `<option value="${num}" ${num === batch.sections ? 'selected' : ''}>${num} ${num === 1 ? 'Section' : 'Sections'}</option>`
                            ).join('')}
                        </select>
                        <select onchange="app.updateDiplomaBatchShift(${index}, this.value)">
                            <option value="morning" ${batch.shift === 'morning' ? 'selected' : ''}>Morning</option>
                            <option value="afternoon" ${batch.shift === 'afternoon' ? 'selected' : ''}>Afternoon</option>
                        </select>
                    `;
                    container.appendChild(batchDiv);
                });

                // Render Regular batch configuration
                const regularContainer = document.getElementById('regular-batch-config-inputs');
                regularContainer.innerHTML = '';

                this.data.regularBatches.forEach((batch, index) => {
                    const batchDiv = document.createElement('div');
                    batchDiv.className = 'batch-input-group';
                    batchDiv.innerHTML = `
                        <label>Batch ${index + 1}</label>
                        <input type="text" value="${batch.name}" onchange="app.updateRegularBatchName(${index}, this.value)" placeholder="Name">
                        <div style="font-size: 11px; color: #666; padding: 4px 0;">1 Section (Fixed)</div>
                    `;
                    regularContainer.appendChild(batchDiv);
                });

                // Sync regular semester name
                const regularSemesterInput = document.getElementById('regular-semester-name-input');
                if (regularSemesterInput) {
                    regularSemesterInput.value = this.data.semesterName;
                }
            },

            // Diploma batch update functions
            updateDiplomaBatchName(index, value) {
                this.data.diplomaBatches[index].name = value;
                this.data.batches[index].name = value;  // Keep backward compatibility
                this.autoSave();
            },

            updateDiplomaBatchSections(index, value) {
                this.data.diplomaBatches[index].sections = parseInt(value);
                this.data.batches[index].sections = parseInt(value);  // Keep backward compatibility
                this.autoSave();
            },

            updateDiplomaBatchShift(index, value) {
                this.data.diplomaBatches[index].shift = value;
                this.data.batches[index].shift = value;  // Keep backward compatibility
                this.renderRoutines();
                this.autoSave();
            },

            // Regular batch update functions
            updateRegularBatchName(index, value) {
                this.data.regularBatches[index].name = value;
                this.autoSave();
            },

            applyRegularBatchConfig() {
                this.initRegularRoutine();
                this.renderRoutines();  // Will render based on active tab
                this.autoSave();
                this.showToast('Regular batch configuration applied successfully!', 'success');
            },

            applyBatchConfig() {
                this.initRoutine();
                this.renderRoutines();
                this.renderTeachersSchedule();
                this.autoSave();
                this.showToast('Batch configuration applied successfully!', 'success');
            },

            renderInfoTab() {
                this.renderCourseCodesInfo();
                this.renderTeachersInfo();
                this.renderRoomsInfo();
            },

            renderCourseCodesInfo() {
                const container = document.getElementById('course-codes-info');
                container.innerHTML = '';

                for (let semester = 1; semester <= 8; semester++) {
                    const semesterDiv = document.createElement('div');
                    semesterDiv.className = 'semester-section';
                    
                    const header = document.createElement('h4');
                    header.textContent = `${this.getOrdinal(semester)} Semester`;
                    semesterDiv.appendChild(header);

                    const list = document.createElement('ul');
                    list.className = 'info-list';

                    (this.data.courses[semester] || []).forEach((course, idx) => {
                        const li = document.createElement('li');
                        li.className = 'info-item course-item';
                        li.innerHTML = `
                            <input type="text" value="${course.code || ''}" placeholder="Code" onchange="app.updateCourse(${semester}, ${idx}, 'code', this.value)">
                            <input type="text" value="${course.title || ''}" placeholder="Title" onchange="app.updateCourse(${semester}, ${idx}, 'title', this.value)">
                            <input type="text" value="${course.credits || ''}" placeholder="Credits" onchange="app.updateCourse(${semester}, ${idx}, 'credits', this.value)">
                            <button class="delete-btn" onclick="app.deleteCourse(${semester}, ${idx})">X</button>
                        `;
                        list.appendChild(li);
                    });

                    semesterDiv.appendChild(list);

                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-btn';
                    addBtn.textContent = '+ Add Course';
                    addBtn.onclick = () => this.addCourse(semester);
                    semesterDiv.appendChild(addBtn);

                    container.appendChild(semesterDiv);
                }
            },

            renderTeachersInfo() {
                const container = document.getElementById('teachers-info');
                const list = document.createElement('ul');
                list.className = 'info-list';
                list.style.display = 'block';

                this.data.teachers.forEach((teacher, idx) => {
                    const li = document.createElement('li');
                    li.className = 'info-item teacher-item-input';
                    li.innerHTML = `
                        <div class="teacher-inputs">
                            <input type="text" value="${teacher.name || ''}" placeholder="Full Name" onchange="app.updateTeacher(${idx}, 'name', this.value)">
                            <input type="text" value="${teacher.short || ''}" placeholder="Short" onchange="app.updateTeacher(${idx}, 'short', this.value)">
                            <input type="text" value="${teacher.phone || ''}" placeholder="Phone" onchange="app.updateTeacher(${idx}, 'phone', this.value)">
                        </div>
                        <div class="teacher-delete-row">
                            <button class="delete-btn" onclick="app.deleteTeacher(${idx})">Remove Faculty</button>
                        </div>
                    `;
                    list.appendChild(li);
                });

                container.innerHTML = '';
                container.appendChild(list);
            },

            renderRoomsInfo() {
                const list = document.getElementById('rooms-list-info');
                list.innerHTML = '';

                this.data.rooms.forEach((room, idx) => {
                    const li = document.createElement('li');
                    li.className = 'info-item';
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    li.style.gap = '3px';
                    // Room input: 75% width, Delete button: 25% width
                    li.innerHTML = `
                        <input type="text" 
                               value="${room || ''}" 
                               onchange="app.updateRoom(${idx}, this.value)" 
                               style="flex: 0 0 75%; min-width: 0; font-size: 12px; height: 36px; padding: 8px 6px;">
                        <button class="delete-btn" 
                                onclick="app.deleteRoom(${idx})" 
                                style="flex: 0 0 calc(25% - 3px); font-size: 12px; font-weight: 700; height: 36px; padding: 8px 4px;">X</button>
                    `;
                    list.appendChild(li);
                });
            },

            addCourse(semester) {
                if (!this.data.courses[semester]) {
                    this.data.courses[semester] = [];
                }
                this.data.courses[semester].push({ code: 'NEW COURSE', title: '', credits: '' });
                this.renderInfoTab();
                this.renderSidebar();
                this.autoSave();
            },

            updateCourse(semester, index, field, value) {
                if (this.data.courses[semester] && this.data.courses[semester][index]) {
                    this.data.courses[semester][index][field] = value;
                    this.renderSidebar();
                    this.autoSave();
                }
            },

            deleteCourse(semester, index) {
                this.data.courses[semester].splice(index, 1);
                this.renderInfoTab();
                this.renderSidebar();
                this.autoSave();
            },

            addTeacher() {
                this.data.teachers.push({ name: 'New Teacher', short: 'NT', phone: '0000000000' });
                this.renderInfoTab();
                this.renderSidebar();
                this.autoSave();
            },

            updateTeacher(index, field, value) {
                if (this.data.teachers[index]) {
                    this.data.teachers[index][field] = value;
                    this.renderSidebar();
                    this.renderTeachersSchedule();
                    this.autoSave();
                }
            },

            deleteTeacher(index) {
                this.data.teachers.splice(index, 1);
                this.renderInfoTab();
                this.renderSidebar();
                this.renderTeachersSchedule();
                this.autoSave();
            },

            addRoom() {
                this.data.rooms.push('0000');
                this.renderInfoTab();
                this.renderSidebar();
                this.autoSave();
            },

            updateRoom(index, value) {
                this.data.rooms[index] = value;
                this.renderSidebar();
                this.autoSave();
            },

            deleteRoom(index) {
                this.data.rooms.splice(index, 1);
                this.renderInfoTab();
                this.renderSidebar();
                this.autoSave();
            },

            getOrdinal(n) {
                const s = ['th', 'st', 'nd', 'rd'];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            },

            findCourse(courseCode) {
                // Search through all semesters to find course
                for (let sem = 1; sem <= 8; sem++) {
                    const courses = this.data.courses[sem] || [];
                    const course = courses.find(c => c.code === courseCode);
                    if (course) return course;
                }
                return null;
            },

            switchBatchType(type) {
                // Update active batch type
                this.data.activeBatchType = type;
                
                // Update tab button styles
                const tabs = document.querySelectorAll('.batch-type-tab');
                tabs.forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                
                // Re-render routines based on selected type
                this.renderRoutines();
            },

            renderRoutines() {
                const container = document.getElementById('routine-main');
                container.innerHTML = '';

                // Check which batch type is active
                if (this.data.activeBatchType === 'regular') {
                    // Render regular batch routines (Phase 3)
                    this.renderRegularRoutines();
                    return;
                }

                // Render diploma batch routines (existing)
                this.data.batches.forEach((batch) => {
                    const batchDiv = document.createElement('div');
                    batchDiv.className = 'batch-routine';

                    const header = document.createElement('div');
                    header.className = 'batch-routine-header';
                    header.innerHTML = `
                        <div class="logo-container">
                            <img src="akmu.png" alt="AKMU Logo" onerror="this.style.display='none'">
                        </div>
                        <div class="header-text">
                            <h1>Anwer Khan Modern University</h1>
                            <h2>Department of Mechanical Engineering</h2>
                            <h3>Class Routine - ${this.data.semesterName}</h3>
                            <div class="batch-title">${batch.name} Batch</div>
                        </div>
                    `;
                    batchDiv.appendChild(header);

                    const daysContainer = document.createElement('div');
                    daysContainer.style.display = 'grid';
                    daysContainer.style.gridTemplateColumns = '3fr 2fr';
                    daysContainer.style.gap = '15px';
                    daysContainer.style.marginLeft = '10px';
                    daysContainer.style.marginRight = '10px';

                    ['friday', 'saturday'].forEach(day => {
                        const dayDiv = document.createElement('div');                       
                        const dayHeader = document.createElement('h3');
                        dayHeader.textContent = day.charAt(0).toUpperCase() + day.slice(1);
                        dayHeader.style.textAlign = 'center';
                        dayHeader.style.marginBottom = '10px';
                        dayHeader.style.fontWeight = '700';
                        dayDiv.appendChild(dayHeader);

                        const table = this.createRoutineTable(batch, day);
                        dayDiv.appendChild(table);
                        daysContainer.appendChild(dayDiv);
                    });

                    batchDiv.appendChild(daysContainer);

                    const teacherBox = this.createTeacherInfoBox(batch);
                    batchDiv.appendChild(teacherBox);

                    container.appendChild(batchDiv);
                });
            },

            renderRegularRoutines() {
                const container = document.getElementById('routine-main');
                container.innerHTML = '';

                this.data.regularBatches.forEach((batch) => {
                    const batchDiv = document.createElement('div');
                    batchDiv.className = 'batch-routine';

                    // Header with logo
                    const header = document.createElement('div');
                    header.className = 'batch-routine-header';
                    header.innerHTML = `
                        <div class="logo-container">
                            <img src="akmu.png" alt="AKMU Logo" onerror="this.style.display='none'">
                        </div>
                        <div class="header-text">
                            <h1>Anwer Khan Modern University</h1>
                            <h2>Department of Mechanical Engineering</h2>
                            <h3>Class Routine - ${this.data.semesterName}</h3>
                            <div class="batch-title">${batch.name} Batch - Regular</div>
                        </div>
                    `;
                    batchDiv.appendChild(header);

                    // Room number drop zone
                    const roomDropZone = document.createElement('div');
                    roomDropZone.className = 'regular-room-header';
                    
                    const hasRoom = this.data.regularBatchRooms[batch.name];
                    roomDropZone.innerHTML = `
                        <div class="regular-room-drop-zone${hasRoom ? ' has-room' : ''}" 
                             data-batch="${batch.name}"
                             ${hasRoom ? `onclick="app.removeRegularBatchRoom('${batch.name}')"` : ''}
                             style="cursor: ${hasRoom ? 'pointer' : 'default'};">
                            ${hasRoom ? `Room: ${hasRoom}` : 'Drop Room'}
                        </div>
                    `;
                    batchDiv.appendChild(roomDropZone);

                    // Create regular routine table
                    const table = this.createRegularRoutineTable(batch);
                    batchDiv.appendChild(table);

                    // Add Faculty Contact info box
                    const teacherBox = this.createRegularTeacherInfoBox(batch);
                    batchDiv.appendChild(teacherBox);

                    container.appendChild(batchDiv);
                });
            },

            createRegularRoutineTable(batch) {
                const table = document.createElement('table');
                table.className = 'regular-routine-table';

                // Table header with time slots
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // First column: Days
                headerRow.innerHTML = `<th class="day-column">Days</th>`;
                
                // Time slot columns (first 3 slots)
                for (let i = 0; i < 3; i++) {
                    const slot = this.data.regularTimeSlots.slots[i];
                    const th = document.createElement('th');
                    th.innerHTML = `${slot.start}-<br>${slot.end}`;
                    headerRow.appendChild(th);
                }
                
                // Prayer and lunch break column header (NO rowSpan)
                const prayerTh = document.createElement('th');
                prayerTh.className = 'prayer-lunch-col';
                prayerTh.innerHTML = 'Prayer and<br>Lunch break';
                prayerTh.style.background = '#f9f9f9';
                prayerTh.style.color = '#000';
                prayerTh.style.fontWeight = '700';
                headerRow.appendChild(prayerTh);
                
                // Last time slot (2:00PM-4:00PM) - rightmost
                const lastSlot = this.data.regularTimeSlots.slots[3];
                const lastTh = document.createElement('th');
                lastTh.innerHTML = `${lastSlot.start}-<br>${lastSlot.end}`;
                headerRow.appendChild(lastTh);
                
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Table body with days
                const tbody = document.createElement('tbody');
                
                this.data.regularTimeSlots.days.forEach((day, dayIndex) => {
                    const row = document.createElement('tr');
                    
                    // Day name cell
                    const dayCell = document.createElement('td');
                    dayCell.className = 'day-cell';
                    dayCell.textContent = day;
                    row.appendChild(dayCell);
                    
                    // First 3 time slot cells
                    for (let slotIndex = 0; slotIndex < 3; slotIndex++) {
                        const cell = this.createRegularCell(batch, day, slotIndex);
                        row.appendChild(cell);
                    }
                    
                    // Prayer/lunch break cell - ONLY create on first row with rowSpan=4
                    if (dayIndex === 0) {
                        const breakCell = document.createElement('td');
                        breakCell.className = 'prayer-lunch-col';
                        breakCell.style.background = '#f9f9f9';
                        breakCell.style.color = '#000';
                        breakCell.style.fontWeight = '700';
                        breakCell.style.verticalAlign = 'middle';
                        breakCell.style.textAlign = 'center';
                        breakCell.rowSpan = 4;  // Merge all 4 day rows
                        breakCell.textContent = 'Prayer and Lunch break';
                        row.appendChild(breakCell);
                    }
                    
                    // Last time slot cell (2:00-4:00PM) - rightmost
                    const lastCell = this.createRegularCell(batch, day, 3);
                    row.appendChild(lastCell);
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                return table;
            },

            createRegularCell(batch, day, slotIndex) {
                const cell = document.createElement('td');
                cell.className = 'regular-routine-cell';
                cell.dataset.batch = batch.name;
                cell.dataset.day = day;
                cell.dataset.slot = slotIndex;
                
                // Get existing data
                const routineData = this.data.regularRoutine[batch.name];
                if (routineData && routineData[day] && routineData[day][slotIndex]) {
                    const cellData = routineData[day][slotIndex];
                    
                    if (cellData.course) {
                        const courseSpan = document.createElement('span');
                        courseSpan.className = 'cell-course';
                        courseSpan.textContent = cellData.course;
                        
                        // Add tooltip
                        const courseObj = this.findCourse(cellData.course);
                        if (courseObj && courseObj.title) {
                            courseSpan.title = courseObj.title;
                        }
                        
                        // Add click to remove
                        courseSpan.onclick = (e) => {
                            e.stopPropagation();
                            this.data.regularRoutine[batch.name][day][slotIndex].course = '';
                            this.renderRoutines();
                            this.autoSave();
                        };
                        courseSpan.style.cursor = 'pointer';
                        
                        cell.appendChild(courseSpan);
                    }
                    
                    if (cellData.teacher) {
                        const teacherSpan = document.createElement('span');
                        teacherSpan.className = 'cell-teacher';
                        teacherSpan.textContent = cellData.teacher;
                        
                        // Add tooltip
                        const teacher = this.data.teachers.find(t => t.short === cellData.teacher);
                        if (teacher && teacher.name) {
                            teacherSpan.title = teacher.name;
                        }
                        
                        // Add click to remove
                        teacherSpan.onclick = (e) => {
                            e.stopPropagation();
                            this.data.regularRoutine[batch.name][day][slotIndex].teacher = '';
                            this.renderRoutines();
                            this.autoSave();
                        };
                        teacherSpan.style.cursor = 'pointer';
                        
                        cell.appendChild(teacherSpan);
                    }
                    
                    if (cellData.room) {
                        const roomSpan = document.createElement('span');
                        roomSpan.className = 'cell-room';
                        roomSpan.textContent = `Room: ${cellData.room}`;
                        
                        // Add click to remove
                        roomSpan.onclick = (e) => {
                            e.stopPropagation();
                            this.data.regularRoutine[batch.name][day][slotIndex].room = '';
                            this.renderRoutines();
                            this.autoSave();
                        };
                        roomSpan.style.cursor = 'pointer';
                        
                        cell.appendChild(roomSpan);
                    }
                }
                
                return cell;
            },

            removeRegularBatchRoom(batchName) {
                this.data.regularBatchRooms[batchName] = '';
                this.renderRoutines();
                this.autoSave();
            },

            createRegularTeacherInfoBox(batch) {
                const box = document.createElement('div');
                box.className = 'teacher-info-box';

                const header = document.createElement('h4');
                header.textContent = 'Faculty Contact Information';
                box.appendChild(header);

                const list = document.createElement('div');
                list.className = 'teacher-info-list';

                const teachersInBatch = new Set();
                
                // Collect all teachers from regular routine for this batch
                const days = this.data.regularTimeSlots.days;
                days.forEach(day => {
                    const dayData = this.data.regularRoutine[batch.name]?.[day] || [];
                    dayData.forEach(slot => {
                        if (slot && slot.teacher) {
                            teachersInBatch.add(slot.teacher);
                        }
                    });
                });

                let counter = 1;
                teachersInBatch.forEach(shortName => {
                    const teacher = this.data.teachers.find(t => t.short === shortName);
                    if (teacher) {
                        const item = document.createElement('div');
                        item.className = 'teacher-info-item';
                        item.innerHTML = `${counter}. ${teacher.short} - ${teacher.name}<br>(Phone: ${teacher.phone})`;
                        list.appendChild(item);
                        counter++;
                    }
                });

                box.appendChild(list);
                return box;
            },

            createRoutineTable(batch, day) {
                const table = document.createElement('table');
                table.className = 'routine-table';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // First cell shows batch name (e.g., "1st Batch")
                headerRow.innerHTML = `<th>${batch.name} Batch</th>`;
                
                let timeSlots;
                if (day === 'friday') {
                    timeSlots = this.data.timeSlots.friday[batch.shift];
                } else {
                    timeSlots = this.data.timeSlots.saturday;
                }
                
                timeSlots.forEach(slot => {
                    const th = document.createElement('th');
                    th.innerHTML = `${slot.start}-<br>${slot.end}`;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                const sections = this.getSectionLetters(batch.sections);

                sections.forEach((section) => {
                    const row = document.createElement('tr');
                    
                    const sectionCell = document.createElement('td');
                    sectionCell.className = 'section-label';
                    
                    const routineKey = `${batch.name}-${section}`;
                    const roomNumber = this.data.sectionRooms[routineKey] || '';
                    
                    const sectionContent = document.createElement('div');
                    sectionContent.className = 'section-room';
                    sectionContent.innerHTML = `
                        <div class="section-name">Sec-${section}</div>
                        <div class="room-drop-zone ${roomNumber ? 'has-room' : ''}" 
                             data-batch="${batch.name}" 
                             data-section="${section}"
                             onclick="app.removeRoomFromSection('${batch.name}', '${section}')">${roomNumber ? 'Room: ' + roomNumber : 'Drop Room'}</div>
                    `;
                    sectionCell.appendChild(sectionContent);
                    row.appendChild(sectionCell);

                    const dayData = this.data.routine[routineKey]?.[day] || [];

                    timeSlots.forEach((slot, slotIdx) => {
                        const cell = document.createElement('td');
                        cell.className = 'routine-cell';
                        cell.dataset.batch = batch.name;
                        cell.dataset.section = section;
                        cell.dataset.day = day;
                        cell.dataset.slot = slotIdx;

                        const data = dayData[slotIdx] || { course: '', teacher: '' };
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'cell-content';
                        
                        if (data.course) {
                            const courseSpan = document.createElement('div');
                            courseSpan.className = 'course-code';
                            courseSpan.textContent = data.course;
                            
                            // Find course title for tooltip
                            let courseTitle = '';
                            for (let sem = 1; sem <= 8; sem++) {
                                const courses = this.data.courses[sem] || [];
                                const foundCourse = courses.find(c => c.code === data.course);
                                if (foundCourse && foundCourse.title) {
                                    courseTitle = foundCourse.title;
                                    break;
                                }
                            }
                            if (courseTitle) {
                                courseSpan.title = courseTitle;  // Tooltip on hover
                            }
                            
                            courseSpan.onclick = (e) => {
                                e.stopPropagation();
                                this.removeFromCell(batch.name, section, day, slotIdx, 'course');
                            };
                            contentDiv.appendChild(courseSpan);
                        }

                        if (data.teacher) {
                            const teacherSpan = document.createElement('div');
                            teacherSpan.className = 'teacher-code';
                            teacherSpan.textContent = data.teacher;
                            
                            // Find teacher full name for tooltip
                            const teacher = this.data.teachers.find(t => t.short === data.teacher);
                            if (teacher && teacher.name) {
                                teacherSpan.title = teacher.name;  // Tooltip on hover
                            }
                            
                            teacherSpan.onclick = (e) => {
                                e.stopPropagation();
                                this.removeFromCell(batch.name, section, day, slotIdx, 'teacher');
                            };
                            contentDiv.appendChild(teacherSpan);
                        }

                        cell.appendChild(contentDiv);
                        row.appendChild(cell);
                    });

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                return table;
            },

            createTeacherInfoBox(batch) {
                const box = document.createElement('div');
                box.className = 'teacher-info-box';

                const header = document.createElement('h4');
                header.textContent = 'Faculty Contact Information';
                box.appendChild(header);

                const list = document.createElement('div');
                list.className = 'teacher-info-list';

                const teachersInBatch = new Set();
                const sections = this.getSectionLetters(batch.sections);
                
                sections.forEach(section => {
                    const routineKey = `${batch.name}-${section}`;
                    ['friday', 'saturday'].forEach(day => {
                        const dayData = this.data.routine[routineKey]?.[day] || [];
                        dayData.forEach(slot => {
                            if (slot.teacher) {
                                teachersInBatch.add(slot.teacher);
                            }
                        });
                    });
                });

                let counter = 1;
                teachersInBatch.forEach(shortName => {
                    const teacher = this.data.teachers.find(t => t.short === shortName);
                    if (teacher) {
                        const item = document.createElement('div');
                        item.className = 'teacher-info-item';
                        item.innerHTML = `${counter}. ${teacher.short} - ${teacher.name}<br>(Phone: ${teacher.phone})`;
                        list.appendChild(item);
                        counter++;
                    }
                });

                box.appendChild(list);
                return box;
            },

            removeFromCell(batch, section, day, slot, type) {
                const key = `${batch}-${section}`;
                if (this.data.routine[key] && this.data.routine[key][day][slot]) {
                    this.data.routine[key][day][slot][type] = '';
                    this.renderRoutines();
                    this.renderSidebar();
                    this.renderTeachersSchedule();
                    this.autoSave();
                }
            },

            removeRoomFromSection(batch, section) {
                const key = `${batch}-${section}`;
                if (this.data.sectionRooms[key]) {
                    this.data.sectionRooms[key] = '';
                    this.renderRoutines();
                    this.autoSave();
                }
            },

            renderSidebar() {
                this.renderSemesterTabs();
                this.renderCoursesList();
                this.renderTeachersList();
                this.renderRoomsList();
            },

            renderSemesterTabs() {
                const container = document.getElementById('semester-tabs');
                container.innerHTML = '';

                for (let i = 1; i <= 8; i++) {
                    const tab = document.createElement('button');
                    tab.className = 'semester-tab' + (i === this.data.currentSemester ? ' active' : '');
                    tab.textContent = this.getOrdinal(i);
                    tab.onclick = () => {
                        this.data.currentSemester = i;
                        this.renderSidebar();
                    };
                    container.appendChild(tab);
                }
            },

            renderCoursesList() {
                const container = document.getElementById('course-codes-list');
                container.innerHTML = '';

                const courses = this.data.courses[this.data.currentSemester] || [];
                courses.forEach(course => {
                    const item = document.createElement('div');
                    item.className = 'draggable-item';
                    item.textContent = course.code || 'N/A';
                    item.draggable = true;
                    item.dataset.type = 'course';
                    item.dataset.value = course.code || '';
                    if (course.title) {
                        item.dataset.title = course.title;
                    }
                    container.appendChild(item);
                });
            },

            renderTeachersList() {
                const container = document.getElementById('teachers-list');
                container.innerHTML = '';

                this.data.teachers.forEach(teacher => {
                    const count = this.getTeacherAssignmentCount(teacher.short);
                    const item = document.createElement('div');
                    item.className = 'draggable-item teacher-item';
                    item.draggable = true;
                    item.dataset.type = 'teacher';
                    item.dataset.value = teacher.short;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${teacher.name} - ${teacher.short}`;
                    
                    const countSpan = document.createElement('span');
                    countSpan.className = 'teacher-count';
                    countSpan.textContent = count;
                    
                    item.appendChild(nameSpan);
                    item.appendChild(countSpan);
                    container.appendChild(item);
                });
            },

            renderRoomsList() {
                const container = document.getElementById('rooms-list');
                container.innerHTML = '';

                this.data.rooms.forEach(room => {
                    const item = document.createElement('div');
                    item.className = 'draggable-item';
                    item.textContent = room;
                    item.draggable = true;
                    item.dataset.type = 'room';
                    item.dataset.value = room;
                    container.appendChild(item);
                });
            },

            getTeacherAssignmentCount(shortName) {
                let count = 0;
                Object.keys(this.data.routine).forEach(key => {
                    this.data.routine[key]['friday'].forEach(slot => {
                        if (slot.teacher === shortName) count++;
                    });
                });
                return count;
            },

            setupDragAndDrop() {
                document.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('draggable-item')) {
                        e.target.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('type', e.target.dataset.type);
                        e.dataTransfer.setData('value', e.target.dataset.value);
                    }
                });

                document.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('dragging')) {
                        e.target.classList.remove('dragging');
                    }
                });

                document.addEventListener('dragover', (e) => {
                    // Block prayer/lunch column
                    if (e.target.classList.contains('prayer-lunch-col') || 
                        e.target.closest('.prayer-lunch-col')) {
                        return;
                    }
                    
                    const cell = e.target.closest('.routine-cell');
                    const regularCell = e.target.closest('.regular-routine-cell');
                    const roomZone = e.target.closest('.room-drop-zone');
                    const regularRoomZone = e.target.closest('.regular-room-drop-zone');
                    
                    if (cell || regularCell || roomZone || regularRoomZone) {
                        e.preventDefault();
                        if (cell) cell.classList.add('drop-zone');
                        if (regularCell) regularCell.style.background = '#e3f2fd';
                        if (roomZone && !roomZone.classList.contains('has-room')) {
                            roomZone.style.background = '#e3f2fd';
                        }
                        if (regularRoomZone && !regularRoomZone.classList.contains('has-room')) {
                            regularRoomZone.style.background = '#e3f2fd';
                        }
                    }
                });

                document.addEventListener('dragleave', (e) => {
                    const cell = e.target.closest('.routine-cell');
                    const regularCell = e.target.closest('.regular-routine-cell');
                    const roomZone = e.target.closest('.room-drop-zone');
                    const regularRoomZone = e.target.closest('.regular-room-drop-zone');
                    
                    if (cell) cell.classList.remove('drop-zone');
                    if (regularCell) regularCell.style.background = '';
                    if (roomZone && !roomZone.classList.contains('has-room')) {
                        roomZone.style.background = 'transparent';
                    }
                    if (regularRoomZone && !regularRoomZone.classList.contains('has-room')) {
                        regularRoomZone.style.background = 'transparent';
                    }
                });

                document.addEventListener('drop', (e) => {
                    // Block prayer/lunch column
                    if (e.target.classList.contains('prayer-lunch-col') || 
                        e.target.closest('.prayer-lunch-col')) {
                        return;
                    }
                    
                    const cell = e.target.closest('.routine-cell');
                    const regularCell = e.target.closest('.regular-routine-cell');
                    const roomZone = e.target.closest('.room-drop-zone');
                    const regularRoomZone = e.target.closest('.regular-room-drop-zone');
                    
                    if (cell) {
                        // Diploma routine cell drop (existing)
                        e.preventDefault();
                        cell.classList.remove('drop-zone');

                        const type = e.dataTransfer.getData('type');
                        const value = e.dataTransfer.getData('value');
                        
                        if (type === 'room') return;

                        const batch = cell.dataset.batch;
                        const section = cell.dataset.section;
                        const day = cell.dataset.day;
                        const slot = parseInt(cell.dataset.slot);

                        const key = `${batch}-${section}`;
                        if (!this.data.routine[key]) {
                            this.data.routine[key] = {
                                friday: Array(5).fill(null).map(() => ({ course: '', teacher: '' })),
                                saturday: Array(4).fill(null).map(() => ({ course: '', teacher: '' }))
                            };
                        }

                        if (!this.data.routine[key][day][slot]) {
                            this.data.routine[key][day][slot] = { course: '', teacher: '' };
                        }

                        this.data.routine[key][day][slot][type] = value;

                        this.renderRoutines();
                        this.renderSidebar();
                        this.renderTeachersSchedule();
                        this.autoSave();
                    } else if (regularCell) {
                        // Regular routine cell drop (new)
                        e.preventDefault();
                        regularCell.style.background = '';

                        const type = e.dataTransfer.getData('type');
                        const value = e.dataTransfer.getData('value');
                        
                        const batch = regularCell.dataset.batch;
                        const day = regularCell.dataset.day;
                        const slot = parseInt(regularCell.dataset.slot);

                        // Initialize if needed
                        if (!this.data.regularRoutine[batch]) {
                            this.data.regularRoutine[batch] = {};
                        }
                        if (!this.data.regularRoutine[batch][day]) {
                            this.data.regularRoutine[batch][day] = Array(4).fill(null).map(() => ({ course: '', teacher: '', room: '' }));
                        }
                        if (!this.data.regularRoutine[batch][day][slot]) {
                            this.data.regularRoutine[batch][day][slot] = { course: '', teacher: '', room: '' };
                        }

                        // Store based on type
                        if (type === 'course') {
                            this.data.regularRoutine[batch][day][slot].course = value;
                        } else if (type === 'teacher') {
                            this.data.regularRoutine[batch][day][slot].teacher = value;
                        } else if (type === 'room') {
                            this.data.regularRoutine[batch][day][slot].room = value;
                        }

                        this.renderRoutines();
                        this.autoSave();
                    } else if (roomZone) {
                        // Diploma room zone drop (existing)
                        e.preventDefault();
                        roomZone.style.background = '';

                        const type = e.dataTransfer.getData('type');
                        const value = e.dataTransfer.getData('value');
                        
                        if (type === 'room') {
                            const batch = roomZone.dataset.batch;
                            const section = roomZone.dataset.section;
                            const key = `${batch}-${section}`;
                            
                            this.data.sectionRooms[key] = value;
                            this.renderRoutines();
                            this.autoSave();
                        }
                    } else if (regularRoomZone) {
                        // Regular room zone drop (new)
                        e.preventDefault();
                        regularRoomZone.style.background = '';

                        const type = e.dataTransfer.getData('type');
                        const value = e.dataTransfer.getData('value');
                        
                        if (type === 'room') {
                            const batch = regularRoomZone.dataset.batch;
                            this.data.regularBatchRooms[batch] = value;
                            this.renderRoutines();
                            this.autoSave();
                        }
                    }
                });
            },

            renderTeachersSchedule() {
                const container = document.getElementById('teachers-schedule-container');
                container.innerHTML = '';

                // === DIPLOMA BATCHES SECTION ===
                const diplomaSection = document.createElement('div');
                diplomaSection.style.marginBottom = '60px';
                
                const diplomaTitle = document.createElement('h2');
                diplomaTitle.textContent = 'Diploma Batches Schedule';
                diplomaTitle.style.marginBottom = '20px';
                diplomaTitle.style.fontWeight = '800';
                diplomaTitle.style.fontSize = '20px';
                diplomaTitle.style.color = '#2c3e50';
                diplomaTitle.style.borderBottom = '3px solid #3498db';
                diplomaTitle.style.paddingBottom = '10px';
                diplomaSection.appendChild(diplomaTitle);

                ['Friday', 'Saturday'].forEach(dayName => {
                    const day = dayName.toLowerCase();
                    const dayDiv = document.createElement('div');
                    dayDiv.style.marginBottom = '40px';

                    const header = document.createElement('h3');
                    header.textContent = `${dayName} Schedule`;
                    header.style.marginBottom = '15px';
                    header.style.fontWeight = '700';
                    dayDiv.appendChild(header);

                    const table = document.createElement('table');
                    table.className = 'teachers-schedule-table';

                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = '<th>Faculty</th>';
                    
                    if (day === 'friday') {
                        this.data.timeSlots.friday.morning.forEach(slot => {
                            const th = document.createElement('th');
                            th.innerHTML = `${slot.start}-<br>${slot.end}`;
                            headerRow.appendChild(th);
                        });
                        this.data.timeSlots.friday.afternoon.forEach(slot => {
                            const th = document.createElement('th');
                            th.innerHTML = `${slot.start}-<br>${slot.end}`;
                            headerRow.appendChild(th);
                        });
                    } else {
                        this.data.timeSlots.saturday.forEach(slot => {
                            const th = document.createElement('th');
                            th.innerHTML = `${slot.start}-<br>${slot.end}`;
                            headerRow.appendChild(th);
                        });
                    }
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    // Filter teachers who have classes on this day
                    const teachersWithClasses = this.data.teachers.filter(teacher => {
                        let hasClass = false;
                        
                        if (day === 'friday') {
                            // Check morning slots
                            for (let slotIdx = 0; slotIdx < this.data.timeSlots.friday.morning.length; slotIdx++) {
                                const assignments = this.getTeacherAssignmentsForSlot(teacher.short, day, slotIdx, 'morning');
                                if (assignments.length > 0) {
                                    hasClass = true;
                                    break;
                                }
                            }
                            // Check afternoon slots
                            if (!hasClass) {
                                for (let slotIdx = 0; slotIdx < this.data.timeSlots.friday.afternoon.length; slotIdx++) {
                                    const assignments = this.getTeacherAssignmentsForSlot(teacher.short, day, slotIdx, 'afternoon');
                                    if (assignments.length > 0) {
                                        hasClass = true;
                                        break;
                                    }
                                }
                            }
                        } else {
                            // Saturday
                            for (let slotIdx = 0; slotIdx < this.data.timeSlots.saturday.length; slotIdx++) {
                                const assignments = this.getTeacherAssignmentsForSlot(teacher.short, day, slotIdx, null);
                                if (assignments.length > 0) {
                                    hasClass = true;
                                    break;
                                }
                            }
                        }
                        
                        return hasClass;
                    });

                    teachersWithClasses.forEach(teacher => {
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.className = 'teacher-name-cell';
                        nameCell.textContent = `${teacher.name} (${teacher.short})`;
                        row.appendChild(nameCell);

                        if (day === 'friday') {
                            this.data.timeSlots.friday.morning.forEach((slot, slotIdx) => {
                                const cell = document.createElement('td');
                                const assignments = this.getTeacherAssignmentsForSlot(teacher.short, day, slotIdx, 'morning');
                                
                                if (assignments.length > 0) {
                                    cell.innerHTML = assignments.map(a => {
                                        const roomNum = this.data.sectionRooms[`${a.batch}-${a.section}`] || '';
                                        return `${a.course}<br><small>${a.batch}-${a.section}${roomNum ? ' (R:' + roomNum + ')' : ''}</small>`;
                                    }).join('<br>');
                                }
                                
                                row.appendChild(cell);
                            });
                            
                            this.data.timeSlots.friday.afternoon.forEach((slot, slotIdx) => {
                                const cell = document.createElement('td');
                                const assignments = this.getTeacherAssignmentsForSlot(teacher.short, day, slotIdx, 'afternoon');
                                
                                if (assignments.length > 0) {
                                    cell.innerHTML = assignments.map(a => {
                                        const roomNum = this.data.sectionRooms[`${a.batch}-${a.section}`] || '';
                                        return `${a.course}<br><small>${a.batch}-${a.section}${roomNum ? ' (R:' + roomNum + ')' : ''}</small>`;
                                    }).join('<br>');
                                }
                                
                                row.appendChild(cell);
                            });
                        } else {
                            this.data.timeSlots.saturday.forEach((slot, slotIdx) => {
                                const cell = document.createElement('td');
                                const assignments = this.getTeacherAssignmentsForSlot(teacher.short, day, slotIdx, null);
                                
                                if (assignments.length > 0) {
                                    cell.innerHTML = assignments.map(a => {
                                        const roomNum = this.data.sectionRooms[`${a.batch}-${a.section}`] || '';
                                        return `${a.course}<br><small>${a.batch}-${a.section}${roomNum ? ' (R:' + roomNum + ')' : ''}</small>`;
                                    }).join('<br>');
                                }
                                
                                row.appendChild(cell);
                            });
                        }

                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    dayDiv.appendChild(table);
                    diplomaSection.appendChild(dayDiv);
                });
                
                container.appendChild(diplomaSection);

                // === REGULAR BATCHES SECTION ===
                const regularSection = document.createElement('div');
                regularSection.style.marginTop = '60px';
                
                const regularTitle = document.createElement('h2');
                regularTitle.textContent = 'Regular Batches Schedule';
                regularTitle.style.marginBottom = '20px';
                regularTitle.style.fontWeight = '800';
                regularTitle.style.fontSize = '20px';
                regularTitle.style.color = '#2c3e50';
                regularTitle.style.borderBottom = '3px solid #27ae60';
                regularTitle.style.paddingBottom = '10px';
                regularSection.appendChild(regularTitle);

                ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(dayName => {
                    const dayDiv = document.createElement('div');
                    dayDiv.style.marginBottom = '40px';

                    const header = document.createElement('h3');
                    header.textContent = `${dayName} Schedule`;
                    header.style.marginBottom = '15px';
                    header.style.fontWeight = '700';
                    dayDiv.appendChild(header);

                    const table = document.createElement('table');
                    table.className = 'teachers-schedule-table';

                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = '<th>Faculty</th>';
                    
                    // Regular batch time slots (4 slots)
                    this.data.regularTimeSlots.slots.forEach(slot => {
                        const th = document.createElement('th');
                        th.innerHTML = `${slot.start}-<br>${slot.end}`;
                        headerRow.appendChild(th);
                    });
                    
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    // Filter teachers who have classes on this day
                    const teachersWithClasses = this.data.teachers.filter(teacher => {
                        let hasClass = false;
                        
                        for (let slotIdx = 0; slotIdx < 4; slotIdx++) {
                            const assignments = this.getRegularTeacherAssignmentsForSlot(teacher.short, dayName, slotIdx);
                            if (assignments.length > 0) {
                                hasClass = true;
                                break;
                            }
                        }
                        
                        return hasClass;
                    });

                    teachersWithClasses.forEach(teacher => {
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.className = 'teacher-name-cell';
                        nameCell.textContent = `${teacher.name} (${teacher.short})`;
                        row.appendChild(nameCell);

                        // Check each time slot
                        for (let slotIdx = 0; slotIdx < 4; slotIdx++) {
                            const cell = document.createElement('td');
                            const assignments = this.getRegularTeacherAssignmentsForSlot(teacher.short, dayName, slotIdx);
                            
                            if (assignments.length > 0) {
                                cell.innerHTML = assignments.map(a => {
                                    const roomNum = this.data.regularBatchRooms[a.batch] || '';
                                    return `${a.course}<br><small>${a.batch} (Reg)${roomNum ? ' (R:' + roomNum + ')' : ''}</small>`;
                                }).join('<br>');
                            }
                            
                            row.appendChild(cell);
                        }

                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    dayDiv.appendChild(table);
                    regularSection.appendChild(dayDiv);
                });
                
                container.appendChild(regularSection);
            },

            getTeacherAssignmentsForSlot(teacherShort, day, slot, shift) {
                const assignments = [];
                
                Object.keys(this.data.routine).forEach(key => {
                    const [batchName, section] = key.split('-');
                    const batch = this.data.batches.find(b => b.name === batchName);
                    
                    if (day === 'friday' && batch && batch.shift !== shift) {
                        return;
                    }
                    
                    const dayData = this.data.routine[key][day];
                    
                    if (dayData && dayData[slot] && dayData[slot].teacher === teacherShort) {
                        assignments.push({
                            batch: batchName,
                            section,
                            course: dayData[slot].course || 'N/A'
                        });
                    }
                });

                return assignments;
            },

            getRegularTeacherAssignmentsForSlot(teacherShort, dayName, slotIndex) {
                const assignments = [];
                
                this.data.regularBatches.forEach(batch => {
                    const batchName = batch.name;
                    const routineData = this.data.regularRoutine[batchName];
                    
                    if (routineData && routineData[dayName] && routineData[dayName][slotIndex]) {
                        const slot = routineData[dayName][slotIndex];
                        if (slot.teacher === teacherShort && slot.course) {
                            assignments.push({
                                batch: batchName,
                                course: slot.course
                            });
                        }
                    }
                });

                return assignments;
            },

            renderCourseDistribution() {
                const container = document.getElementById('course-distribution-container');
                container.innerHTML = '';

                // Create card with header
                const card = document.createElement('div');
                card.className = 'course-distribution-card';

                // Header with logo (same as class routine)
                const header = document.createElement('div');
                header.className = 'batch-routine-header';
                header.innerHTML = `
                    <div class="logo-container">
                        <img src="akmu.png" alt="AKMU Logo" onerror="this.style.display='none'">
                    </div>
                    <div class="header-text">
                        <h1>Anwer Khan Modern University</h1>
                        <h2>Department of Mechanical Engineering</h2>
                        <h3>Course Distribution - ${this.data.semesterName}</h3>
                    </div>
                `;
                card.appendChild(header);

                // Create table
                const table = document.createElement('table');
                table.className = 'course-distribution-table';

                // Table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th class="sl-no">Sl No.</th>
                        <th class="faculty-name">Faculty Name</th>
                        <th class="course-info">Courses Code and Title</th>
                        <th class="batch-section">Batch/Section</th>
                        <th class="credits">Credits</th>
                        <th class="total-credits">Total Credits</th>
                    </tr>
                `;
                table.appendChild(thead);

                // Table body
                const tbody = document.createElement('tbody');
                
                // Collect course data for each teacher
                let slNo = 1;
                this.data.teachers.forEach(teacher => {
                    const teacherCourses = [];
                    
                    // DIPLOMA BATCHES: Find all courses assigned to this teacher
                    Object.keys(this.data.routine).forEach(key => {
                        const [batch, section] = key.split('-');
                        
                        ['friday', 'saturday'].forEach(day => {
                            const dayData = this.data.routine[key][day];
                            dayData.forEach(slot => {
                                if (slot.teacher === teacher.short && slot.course) {
                                    // Find course details
                                    let courseTitle = '';
                                    let courseCredits = 0;
                                    
                                    for (let sem = 1; sem <= 8; sem++) {
                                        const course = (this.data.courses[sem] || []).find(c => c.code === slot.course);
                                        if (course) {
                                            courseTitle = course.title || '';
                                            courseCredits = parseFloat(course.credits) || 0;
                                            break;
                                        }
                                    }
                                    
                                    // Check if this exact combination already exists
                                    const exists = teacherCourses.some(tc => 
                                        tc.code === slot.course && 
                                        tc.batch === batch && 
                                        tc.section === section &&
                                        tc.type === 'diploma'
                                    );
                                    
                                    if (!exists) {
                                        teacherCourses.push({
                                            code: slot.course,
                                            title: courseTitle,
                                            batch: batch,
                                            section: section,
                                            credits: courseCredits,
                                            type: 'diploma'
                                        });
                                    }
                                }
                            });
                        });
                    });
                    
                    // REGULAR BATCHES: Find all courses assigned to this teacher
                    this.data.regularBatches.forEach(batch => {
                        const batchName = batch.name;
                        const routineData = this.data.regularRoutine[batchName];
                        
                        if (routineData) {
                            ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                                const dayData = routineData[day] || [];
                                dayData.forEach(slot => {
                                    if (slot && slot.teacher === teacher.short && slot.course) {
                                        // Find course details
                                        let courseTitle = '';
                                        let courseCredits = 0;
                                        
                                        for (let sem = 1; sem <= 8; sem++) {
                                            const course = (this.data.courses[sem] || []).find(c => c.code === slot.course);
                                            if (course) {
                                                courseTitle = course.title || '';
                                                courseCredits = parseFloat(course.credits) || 0;
                                                break;
                                            }
                                        }
                                        
                                        // Check if this exact combination already exists
                                        const exists = teacherCourses.some(tc => 
                                            tc.code === slot.course && 
                                            tc.batch === batchName && 
                                            tc.type === 'regular'
                                        );
                                        
                                        if (!exists) {
                                            teacherCourses.push({
                                                code: slot.course,
                                                title: courseTitle,
                                                batch: batchName,
                                                section: '',  // Regular batches don't have sections
                                                credits: courseCredits,
                                                type: 'regular'
                                            });
                                        }
                                    }
                                });
                            });
                        }
                    });

                    // Calculate total credits
                    const totalCredits = teacherCourses.reduce((sum, c) => sum + c.credits, 0);

                    // Create rows for this teacher
                    if (teacherCourses.length > 0) {
                        teacherCourses.forEach((course, index) => {
                            const row = document.createElement('tr');
                            
                            // Sl No - only in first row (merged)
                            if (index === 0) {
                                const slCell = document.createElement('td');
                                slCell.className = 'sl-no';
                                slCell.textContent = String(slNo).padStart(2, '0') + '.';
                                slCell.rowSpan = teacherCourses.length;
                                row.appendChild(slCell);
                                
                                // Faculty Name - only in first row (merged)
                                const nameCell = document.createElement('td');
                                nameCell.className = 'faculty-name';
                                nameCell.textContent = teacher.name;
                                nameCell.rowSpan = teacherCourses.length;
                                row.appendChild(nameCell);
                            }
                            
                            // Course Code and Title
                            const courseCell = document.createElement('td');
                            courseCell.className = 'course-info';
                            courseCell.textContent = course.title ? 
                                `${course.code}: ${course.title}` : 
                                course.code;
                            row.appendChild(courseCell);
                            
                            // Batch/Section - mark regular batches with (Reg)
                            const batchCell = document.createElement('td');
                            batchCell.className = 'batch-section';
                            if (course.type === 'regular') {
                                batchCell.textContent = `${course.batch} (Reg)`;
                            } else {
                                batchCell.textContent = `${course.batch}-${course.section}`;
                            }
                            row.appendChild(batchCell);
                            
                            // Credits
                            const creditsCell = document.createElement('td');
                            creditsCell.className = 'credits';
                            creditsCell.textContent = course.credits.toFixed(2);
                            row.appendChild(creditsCell);
                            
                            // Total Credits - only in first row (merged)
                            if (index === 0) {
                                const totalCell = document.createElement('td');
                                totalCell.className = 'total-credits';
                                totalCell.textContent = totalCredits.toFixed(2);
                                totalCell.rowSpan = teacherCourses.length;
                                row.appendChild(totalCell);
                            }
                            
                            tbody.appendChild(row);
                        });
                        
                        slNo++;
                    }
                });

                table.appendChild(tbody);
                card.appendChild(table);
                container.appendChild(card);
            },

            checkOverlap() {
                // Check if we're on regular batch type
                if (this.data.activeBatchType === 'regular') {
                    this.checkRegularOverlap();
                    return;
                }
                
                const overlaps = [];
                const debugInfo = {
                    courseChecked: 0,
                    courseFound: 0,
                    roomChecked: 0,
                    roomFound: 0,
                    teacherChecked: 0,
                    teacherFound: 0,
                    mismatchChecked: 0,
                    mismatchFound: 0
                };
                
                // ========================================
                // CLEAR PREVIOUS OVERLAP HIGHLIGHTS
                // ========================================
                document.querySelectorAll('.routine-cell.overlap').forEach(cell => {
                    cell.classList.remove('overlap');
                });
                document.querySelectorAll('.room-drop-zone.room-overlap').forEach(zone => {
                    zone.classList.remove('room-overlap');
                });

                // ========================================
                // 1. COURSE OVERLAP CHECK
                // Checks if same course appears multiple times in same section on same day
                // ========================================
                Object.keys(this.data.routine).forEach(key => {
                    const [batch, section] = key.split('-');
                    
                    ['friday', 'saturday'].forEach(day => {
                        debugInfo.courseChecked++;
                        const dayData = this.data.routine[key][day];
                        const courses = dayData.map(slot => slot.course).filter(c => c);
                        const duplicates = courses.filter((course, index) => courses.indexOf(course) !== index);
                        
                        if (duplicates.length > 0) {
                            debugInfo.courseFound++;
                            duplicates.forEach(course => {
                                dayData.forEach((slot, slotIdx) => {
                                    if (slot.course === course) {
                                        overlaps.push({
                                            type: 'course',
                                            batch,
                                            section,
                                            day,
                                            slot: slotIdx,
                                            value: course
                                        });
                                    }
                                });
                            });
                        }
                    });
                });

                // ========================================
                // 2. ROOM OVERLAP CHECK (INDEPENDENT)
                // Checks if same room is assigned to multiple sections in same shift
                // DOES NOT check if classes exist - just room assignments
                // ========================================
                ['morning', 'afternoon'].forEach(shift => {
                    for (let slotIdx = 0; slotIdx < 5; slotIdx++) {
                        const roomsInThisSlot = {};
                        
                        // Collect ALL rooms assigned to sections in this shift
                        Object.keys(this.data.sectionRooms).forEach(sectionKey => {
                            const roomNum = this.data.sectionRooms[sectionKey];
                            if (!roomNum) return; // Skip if no room assigned
                            
                            const [batchName, sectionLetter] = sectionKey.split('-');
                            const batchObj = this.data.batches.find(b => b.name === batchName);
                            
                            if (!batchObj || batchObj.shift !== shift) return; // Wrong shift
                            
                            // Room is assigned to this section in this shift
                            // Add it to tracking (regardless of whether class exists)
                            if (!roomsInThisSlot[roomNum]) {
                                roomsInThisSlot[roomNum] = [];
                            }
                            roomsInThisSlot[roomNum].push({
                                batch: batchName,
                                section: sectionLetter,
                                sectionKey: sectionKey
                            });
                        });
                        
                        // Find duplicate room assignments
                        Object.keys(roomsInThisSlot).forEach(roomNum => {
                            const sectionsUsingRoom = roomsInThisSlot[roomNum];
                            debugInfo.roomChecked++;
                            
                            if (sectionsUsingRoom.length > 1) {
                                debugInfo.roomFound++;
                                // This room is assigned to multiple sections!
                                sectionsUsingRoom.forEach(({batch, section}) => {
                                    overlaps.push({
                                        type: 'room',
                                        batch: batch,
                                        section: section,
                                        day: 'friday',
                                        slot: slotIdx,
                                        value: roomNum,
                                        shift: shift
                                    });
                                });
                            }
                        });
                    }
                });

                // ========================================
                // 3. TEACHER OVERLAP CHECK
                // Checks if same teacher is scheduled in multiple sections at same time
                // ========================================
                ['friday', 'saturday'].forEach(day => {
                    if (day === 'friday') {
                        ['morning', 'afternoon'].forEach(shift => {
                            for (let slotIdx = 0; slotIdx < 5; slotIdx++) {
                                const teachersInSlot = {};
                                
                                Object.keys(this.data.routine).forEach(key => {
                                    const [batchName, section] = key.split('-');
                                    const batch = this.data.batches.find(b => b.name === batchName);
                                    
                                    if (batch && batch.shift === shift) {
                                        const slotData = this.data.routine[key][day][slotIdx];
                                        
                                        if (slotData && slotData.teacher) {
                                            if (!teachersInSlot[slotData.teacher]) {
                                                teachersInSlot[slotData.teacher] = [];
                                            }
                                            teachersInSlot[slotData.teacher].push({ batch: batchName, section });
                                        }
                                    }
                                });

                                debugInfo.teacherChecked++;
                                Object.keys(teachersInSlot).forEach(teacher => {
                                    if (teachersInSlot[teacher].length > 1) {
                                        debugInfo.teacherFound++;
                                        teachersInSlot[teacher].forEach(({ batch, section }) => {
                                            overlaps.push({
                                                type: 'teacher',
                                                batch,
                                                section,
                                                day,
                                                slot: slotIdx,
                                                value: teacher
                                            });
                                        });
                                    }
                                });
                            }
                        });
                    } else {
                        // Saturday
                        for (let slotIdx = 0; slotIdx < 4; slotIdx++) {
                            const teachersInSlot = {};
                            
                            Object.keys(this.data.routine).forEach(key => {
                                const [batch, section] = key.split('-');
                                const slotData = this.data.routine[key][day][slotIdx];
                                
                                if (slotData && slotData.teacher) {
                                    if (!teachersInSlot[slotData.teacher]) {
                                        teachersInSlot[slotData.teacher] = [];
                                    }
                                    teachersInSlot[slotData.teacher].push({ batch, section });
                                }
                            });

                            debugInfo.teacherChecked++;
                            Object.keys(teachersInSlot).forEach(teacher => {
                                if (teachersInSlot[teacher].length > 1) {
                                    debugInfo.teacherFound++;
                                    teachersInSlot[teacher].forEach(({ batch, section }) => {
                                        overlaps.push({
                                            type: 'teacher',
                                            batch,
                                            section,
                                            day,
                                            slot: slotIdx,
                                            value: teacher
                                        });
                                    });
                                }
                            });
                        }
                    }
                });

                // ========================================
                // 4. COURSE/TEACHER MISMATCH CHECK
                // Checks if cells have course without teacher OR teacher without course
                // ========================================
                Object.keys(this.data.routine).forEach(key => {
                    const [batch, section] = key.split('-');
                    
                    ['friday', 'saturday'].forEach(day => {
                        const dayData = this.data.routine[key][day];
                        
                        dayData.forEach((slot, slotIdx) => {
                            debugInfo.mismatchChecked++;
                            const hasCourse = slot.course && slot.course.trim() !== '';
                            const hasTeacher = slot.teacher && slot.teacher.trim() !== '';
                            
                            // Check for mismatch
                            if (hasCourse && !hasTeacher) {
                                debugInfo.mismatchFound++;
                                overlaps.push({
                                    type: 'course-no-teacher',
                                    batch,
                                    section,
                                    day,
                                    slot: slotIdx,
                                    value: slot.course
                                });
                            } else if (hasTeacher && !hasCourse) {
                                debugInfo.mismatchFound++;
                                overlaps.push({
                                    type: 'teacher-no-course',
                                    batch,
                                    section,
                                    day,
                                    slot: slotIdx,
                                    value: slot.teacher
                                });
                            }
                        });
                    });
                });

		// ========================================
// 5. MISSING ROOM NUMBER CHECK
// Checks if sections with classes have no room assigned
// ========================================
Object.keys(this.data.routine).forEach(key => {
    const [batch, section] = key.split('-');
    const roomNum = this.data.sectionRooms[key];
    
    // Check if this section has any classes scheduled
    let hasClasses = false;
    ['friday', 'saturday'].forEach(day => {
        const dayData = this.data.routine[key][day];
        dayData.forEach(slot => {
            if ((slot.course && slot.course.trim() !== '') || 
                (slot.teacher && slot.teacher.trim() !== '')) {
                hasClasses = true;
            }
        });
    });

// If section has classes but no room assigned
    if (hasClasses && (!roomNum || roomNum.trim() === '')) {
        overlaps.push({
            type: 'no-room',
            batch: batch,
            section: section,
            value: `${batch}-${section}`
        });
    }
});

              // ========================================
// HIGHLIGHT ALL OVERLAPS
// Different highlighting for rooms vs cells
// ========================================
overlaps.forEach(overlap => {
    if (overlap.type === 'room' || overlap.type === 'no-room') {
        // Highlight room drop zone for both room overlaps and missing rooms
        const roomZones = document.querySelectorAll(
            `.room-drop-zone[data-batch="${overlap.batch}"][data-section="${overlap.section}"]`
        );
        roomZones.forEach(zone => zone.classList.add('room-overlap'));
    } else {
                        // Highlight routine cell
                        const cells = document.querySelectorAll(
                            `.routine-cell[data-batch="${overlap.batch}"][data-section="${overlap.section}"][data-day="${overlap.day}"][data-slot="${overlap.slot}"]`
                        );
                        cells.forEach(cell => cell.classList.add('overlap'));
                    }
                });

                // ========================================
                // SHOW RESULTS
                // ========================================
                if (overlaps.length > 0) {
                    const message = this.formatOverlapMessage(overlaps);
                    this.showToast(message, 'error');
                } else {
                    this.showToast('‚úì No overlaps found! Schedule is valid.', 'success');
                }
            },

            formatOverlapMessage(overlaps) {
                const grouped = {};
                
                // Group overlaps by type and value
                overlaps.forEach(overlap => {
                    const key = `${overlap.type}-${overlap.value}`;
                    if (!grouped[key]) {
                        grouped[key] = [];
                    }
                    grouped[key].push(overlap);
                });

                let message = '‚ùå Overlaps detected:\n\n';
                
                Object.keys(grouped).forEach(key => {
                    const items = grouped[key];
                    const type = items[0].type;
                    const value = items[0].value;
                    
                    if (type === 'course') {
                        message += `üìö Course ${value} appears multiple times in:\n`;
                        items.forEach(item => {
                            const batch = this.data.batches.find(b => b.name === item.batch);
                            let timeSlot;
                            if (item.day === 'friday' && batch) {
                                timeSlot = this.data.timeSlots.friday[batch.shift][item.slot];
                            } else if (item.day === 'saturday') {
                                timeSlot = this.data.timeSlots.saturday[item.slot];
                            }
                            if (timeSlot) {
                                message += `  ‚Ä¢ ${item.batch} Batch Sec-${item.section}, ${item.day}, ${timeSlot.start}-${timeSlot.end}\n`;
                            }
                        });
                    } else if (type === 'teacher') {
                        message += `üë®‚Äçüè´ Faculty ${value} has multiple classes at:\n`;
                        items.forEach(item => {
                            const batch = this.data.batches.find(b => b.name === item.batch);
                            let timeSlot;
                            if (item.day === 'friday' && batch) {
                                timeSlot = this.data.timeSlots.friday[batch.shift][item.slot];
                            } else if (item.day === 'saturday') {
                                timeSlot = this.data.timeSlots.saturday[item.slot];
                            }
                            if (timeSlot) {
                                message += `  ‚Ä¢ ${item.batch} Batch Sec-${item.section}, ${item.day}, ${timeSlot.start}-${timeSlot.end}\n`;
                            }
                        });
                    } else if (type === 'room') {
                        // Format: Room 3201 is used multiple times in 1st Batch Sec-A, 3rd Batch Sec-C
                        const sections = items.map(item => `${item.batch} Batch Sec-${item.section}`).join(', ');
                        message += `üè´ Room ${value} is used multiple times in ${sections}\n`;
                    } else if (type === 'course-no-teacher') {
                        // Format: No Faculty is assigned in 3rd Batch Sec-B, Room- 3201, Time: 09:50AM-10:40AM
                        items.forEach(item => {
                            const batch = this.data.batches.find(b => b.name === item.batch);
                            const roomNum = this.data.sectionRooms[`${item.batch}-${item.section}`] || 'N/A';
                            let timeSlot;
                            if (item.day === 'friday' && batch) {
                                timeSlot = this.data.timeSlots.friday[batch.shift][item.slot];
                            } else if (item.day === 'saturday') {
                                timeSlot = this.data.timeSlots.saturday[item.slot];
                            }
                            if (timeSlot) {
                                message += `‚ö†Ô∏è No Faculty is assigned in ${item.batch} Batch Sec-${item.section}, Room- ${roomNum}, Time: ${timeSlot.start}-${timeSlot.end}\n`;
                            }
                        });
                    } else if (type === 'teacher-no-course') {
                        // Format: No Course is assigned in 3rd Batch Sec-B, Room- 3201, Time: 09:50AM-10:40AM
                        items.forEach(item => {
                            const batch = this.data.batches.find(b => b.name === item.batch);
                            const roomNum = this.data.sectionRooms[`${item.batch}-${item.section}`] || 'N/A';
                            let timeSlot;
                            if (item.day === 'friday' && batch) {
                                timeSlot = this.data.timeSlots.friday[batch.shift][item.slot];
                            } else if (item.day === 'saturday') {
                                timeSlot = this.data.timeSlots.saturday[item.slot];
                            }
                            if (timeSlot) {
                                message += `‚ö†Ô∏è No Course is assigned in ${item.batch} Batch Sec-${item.section}, Room- ${roomNum}, Time: ${timeSlot.start}-${timeSlot.end}\n`;
                            }
                        });
                    } else if (type === 'no-room') {
    // Format: 2nd batch Sec-C has no Room Number assigned!
    items.forEach(item => {
        message += `‚ö†Ô∏è ${item.batch} Batch Sec-${item.section} has no Room Number assigned!\n`;
    });
}
message += '\n';
                    
                });

                return message;
            },

            checkRegularOverlap() {
                const overlaps = [];
                
                // Clear previous highlights (if any)
                document.querySelectorAll('.regular-routine-cell.overlap').forEach(cell => {
                    cell.classList.remove('overlap');
                });
                
                // === 1. COURSE OVERLAP CHECK ===
                // Check if same course appears multiple times in same batch on same day
                this.data.regularBatches.forEach(batch => {
                    const batchName = batch.name;
                    const routineData = this.data.regularRoutine[batchName];
                    
                    if (routineData) {
                        ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                            const dayData = routineData[day] || [];
                            const courses = dayData.map(slot => slot?.course).filter(c => c);
                            const duplicates = courses.filter((course, index) => courses.indexOf(course) !== index);
                            
                            if (duplicates.length > 0) {
                                duplicates.forEach(course => {
                                    dayData.forEach((slot, slotIdx) => {
                                        if (slot && slot.course === course) {
                                            overlaps.push({
                                                type: 'course',
                                                batch: batchName,
                                                day,
                                                slot: slotIdx,
                                                value: course
                                            });
                                        }
                                    });
                                });
                            }
                        });
                    }
                });
                
                // === 2. TEACHER OVERLAP CHECK ===
                // Check if same teacher is scheduled in multiple batches at same time
                ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                    for (let slotIdx = 0; slotIdx < 4; slotIdx++) {
                        const teachersInSlot = {};
                        
                        this.data.regularBatches.forEach(batch => {
                            const batchName = batch.name;
                            const routineData = this.data.regularRoutine[batchName];
                            
                            if (routineData && routineData[day] && routineData[day][slotIdx]) {
                                const slot = routineData[day][slotIdx];
                                if (slot.teacher) {
                                    if (!teachersInSlot[slot.teacher]) {
                                        teachersInSlot[slot.teacher] = [];
                                    }
                                    teachersInSlot[slot.teacher].push({ batch: batchName });
                                }
                            }
                        });
                        
                        // Check for duplicates
                        Object.keys(teachersInSlot).forEach(teacher => {
                            if (teachersInSlot[teacher].length > 1) {
                                teachersInSlot[teacher].forEach(({ batch }) => {
                                    overlaps.push({
                                        type: 'teacher',
                                        batch,
                                        day,
                                        slot: slotIdx,
                                        value: teacher
                                    });
                                });
                            }
                        });
                    }
                });
                
                // === 3. ROOM OVERLAP CHECK ===
                // Check if same room is used by multiple batches at same time
                ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                    for (let slotIdx = 0; slotIdx < 4; slotIdx++) {
                        const roomsInSlot = {};
                        
                        this.data.regularBatches.forEach(batch => {
                            const batchName = batch.name;
                            const batchRoom = this.data.regularBatchRooms[batchName];
                            
                            if (batchRoom) {
                                const routineData = this.data.regularRoutine[batchName];
                                
                                // Check if there's actually a class scheduled
                                if (routineData && routineData[day] && routineData[day][slotIdx]) {
                                    const slot = routineData[day][slotIdx];
                                    if (slot.course || slot.teacher) {
                                        if (!roomsInSlot[batchRoom]) {
                                            roomsInSlot[batchRoom] = [];
                                        }
                                        roomsInSlot[batchRoom].push({ batch: batchName });
                                    }
                                }
                            }
                        });
                        
                        // Check for duplicate room usage
                        Object.keys(roomsInSlot).forEach(room => {
                            if (roomsInSlot[room].length > 1) {
                                roomsInSlot[room].forEach(({ batch }) => {
                                    overlaps.push({
                                        type: 'room',
                                        batch,
                                        day,
                                        slot: slotIdx,
                                        value: room
                                    });
                                });
                            }
                        });
                    }
                });
                
                // === 4. BATCH ROOM NUMBER OVERLAP CHECK (TOP LEFT DROP ZONE) ===
                // Check if same room number is assigned to multiple batches in the header drop zone
                const batchRoomAssignments = {};
                this.data.regularBatches.forEach(batch => {
                    const batchName = batch.name;
                    const roomNum = this.data.regularBatchRooms[batchName];
                    
                    if (roomNum) {
                        if (!batchRoomAssignments[roomNum]) {
                            batchRoomAssignments[roomNum] = [];
                        }
                        batchRoomAssignments[roomNum].push(batchName);
                    }
                });
                
                // Find duplicate room assignments
                Object.keys(batchRoomAssignments).forEach(roomNum => {
                    const batches = batchRoomAssignments[roomNum];
                    if (batches.length > 1) {
                        batches.forEach(batchName => {
                            overlaps.push({
                                type: 'batch-room-duplicate',
                                batch: batchName,
                                value: roomNum,
                                batches: batches  // All batches using this room
                            });
                        });
                    }
                });
                
                // === 5. TEACHER WITHOUT COURSE CHECK ===
                // Check for cells with teacher assigned but no course
                this.data.regularBatches.forEach(batch => {
                    const batchName = batch.name;
                    const routineData = this.data.regularRoutine[batchName];
                    
                    if (routineData) {
                        ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                            const dayData = routineData[day] || [];
                            dayData.forEach((slot, slotIdx) => {
                                if (slot && slot.teacher && !slot.course) {
                                    overlaps.push({
                                        type: 'no-course',
                                        batch: batchName,
                                        day,
                                        slot: slotIdx,
                                        value: slot.teacher
                                    });
                                }
                            });
                        });
                    }
                });
                
                // === 6. COURSE WITHOUT TEACHER CHECK ===
                // Check for cells with course assigned but no teacher
                this.data.regularBatches.forEach(batch => {
                    const batchName = batch.name;
                    const routineData = this.data.regularRoutine[batchName];
                    
                    if (routineData) {
                        ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                            const dayData = routineData[day] || [];
                            dayData.forEach((slot, slotIdx) => {
                                if (slot && slot.course && !slot.teacher) {
                                    overlaps.push({
                                        type: 'no-teacher',
                                        batch: batchName,
                                        day,
                                        slot: slotIdx,
                                        value: slot.course
                                    });
                                }
                            });
                        });
                    }
                });
                
                // === 7. MISSING BATCH ROOM NUMBER CHECK ===
                // Check if batch has classes but no room number assigned
                this.data.regularBatches.forEach(batch => {
                    const batchName = batch.name;
                    const roomNum = this.data.regularBatchRooms[batchName];
                    const routineData = this.data.regularRoutine[batchName];
                    
                    if (!roomNum && routineData) {
                        // Check if this batch has any classes
                        let hasClasses = false;
                        ['Saturday', 'Sunday', 'Monday', 'Thursday'].forEach(day => {
                            const dayData = routineData[day] || [];
                            dayData.forEach(slot => {
                                if (slot && (slot.course || slot.teacher)) {
                                    hasClasses = true;
                                }
                            });
                        });
                        
                        if (hasClasses) {
                            overlaps.push({
                                type: 'no-batch-room',
                                batch: batchName
                            });
                        }
                    }
                });
                
                // === HIGHLIGHT OVERLAPS ===
                overlaps.forEach(overlap => {
                    const cell = document.querySelector(
                        `.regular-routine-cell[data-batch="${overlap.batch}"][data-day="${overlap.day}"][data-slot="${overlap.slot}"]`
                    );
                    if (cell) {
                        cell.classList.add('overlap');
                        cell.style.background = '#ffebee';
                        cell.style.border = '2px solid var(--danger-color)';
                    }
                });
                
                // === DISPLAY RESULTS ===
                if (overlaps.length === 0) {
                    this.showToast('‚úÖ No overlaps found in Regular batch routines!', 'success');
                } else {
                    // Group overlaps by type
                    const grouped = {};
                    overlaps.forEach(o => {
                        if (!grouped[o.type]) grouped[o.type] = [];
                        grouped[o.type].push(o);
                    });
                    
                    let message = `‚ö†Ô∏è Found ${overlaps.length} overlap(s) in Regular batches:\n\n`;
                    
                    if (grouped.course) {
                        message += `üìö COURSE OVERLAPS (${grouped.course.length}):\n`;
                        const uniqueCourses = {};
                        grouped.course.forEach(o => {
                            const key = `${o.batch}-${o.day}-${o.value}`;
                            if (!uniqueCourses[key]) {
                                uniqueCourses[key] = [];
                            }
                            const timeSlot = this.data.regularTimeSlots.slots[o.slot];
                            uniqueCourses[key].push(`${timeSlot.start}-${timeSlot.end}`);
                        });
                        Object.keys(uniqueCourses).forEach(key => {
                            const [batch, day, course] = key.split('-');
                            message += `  ‚Ä¢ ${course} appears ${uniqueCourses[key].length} times in ${batch} (Reg) on ${day}\n`;
                        });
                        message += '\n';
                    }
                    
                    if (grouped.teacher) {
                        message += `üë®‚Äçüè´ TEACHER OVERLAPS (${grouped.teacher.length}):\n`;
                        const uniqueTeachers = {};
                        grouped.teacher.forEach(o => {
                            const key = `${o.day}-${o.slot}-${o.value}`;
                            if (!uniqueTeachers[key]) {
                                uniqueTeachers[key] = [];
                            }
                            uniqueTeachers[key].push(o.batch);
                        });
                        Object.keys(uniqueTeachers).forEach(key => {
                            const [day, slotIdx, teacher] = key.split('-');
                            const timeSlot = this.data.regularTimeSlots.slots[parseInt(slotIdx)];
                            const batches = [...new Set(uniqueTeachers[key])].join(', ');
                            message += `  ‚Ä¢ ${teacher} scheduled in ${uniqueTeachers[key].length} batches on ${day} at ${timeSlot.start}-${timeSlot.end} (${batches})\n`;
                        });
                        message += '\n';
                    }
                    
                    if (grouped.room) {
                        message += `üè¢ ROOM OVERLAPS (${grouped.room.length}):\n`;
                        const uniqueRooms = {};
                        grouped.room.forEach(o => {
                            const key = `${o.day}-${o.slot}-${o.value}`;
                            if (!uniqueRooms[key]) {
                                uniqueRooms[key] = [];
                            }
                            uniqueRooms[key].push(o.batch);
                        });
                        Object.keys(uniqueRooms).forEach(key => {
                            const [day, slotIdx, room] = key.split('-');
                            const timeSlot = this.data.regularTimeSlots.slots[parseInt(slotIdx)];
                            const batches = [...new Set(uniqueRooms[key])].join(', ');
                            message += `  ‚Ä¢ Room ${room} used by ${uniqueRooms[key].length} batches on ${day} at ${timeSlot.start}-${timeSlot.end} (${batches})\n`;
                        });
                        message += '\n';
                    }
                    
                    if (grouped['batch-room-duplicate']) {
                        message += `üö™ BATCH ROOM NUMBER DUPLICATES (${grouped['batch-room-duplicate'].length}):\n`;
                        const uniqueBatchRooms = {};
                        grouped['batch-room-duplicate'].forEach(o => {
                            if (!uniqueBatchRooms[o.value]) {
                                uniqueBatchRooms[o.value] = o.batches;
                            }
                        });
                        Object.keys(uniqueBatchRooms).forEach(roomNum => {
                            const batches = uniqueBatchRooms[roomNum].map(b => `${b} Batch`).join(', ');
                            message += `  ‚Ä¢ Same room no - ${roomNum} allotted for multiple batches (${batches})\n`;
                        });
                        message += '\n';
                    }
                    
                    if (grouped['no-course']) {
                        message += `üìö MISSING COURSES (${grouped['no-course'].length}):\n`;
                        grouped['no-course'].forEach(o => {
                            const timeSlot = this.data.regularTimeSlots.slots[o.slot];
                            message += `  ‚Ä¢ No course assigned on ${o.batch} batch ${o.day} ${timeSlot.start}-${timeSlot.end}\n`;
                        });
                        message += '\n';
                    }
                    
                    if (grouped['no-teacher']) {
                        message += `üë®‚Äçüè´ MISSING FACULTY (${grouped['no-teacher'].length}):\n`;
                        grouped['no-teacher'].forEach(o => {
                            const timeSlot = this.data.regularTimeSlots.slots[o.slot];
                            message += `  ‚Ä¢ No faculty is assigned on ${o.batch} batch ${o.day} ${timeSlot.start}-${timeSlot.end}\n`;
                        });
                        message += '\n';
                    }
                    
                    if (grouped['no-batch-room']) {
                        message += `üö™ MISSING BATCH ROOM NUMBERS (${grouped['no-batch-room'].length}):\n`;
                        grouped['no-batch-room'].forEach(o => {
                            message += `  ‚Ä¢ No room no is allotted for ${o.batch} Batch\n`;
                        });
                    }
                    
                    this.showToast(message, 'warning');
                }
            },

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toast.style.whiteSpace = 'pre-line';
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            },

            saveData() {
                const data = {
                    semesterName: this.data.semesterName,
                    batches: this.data.batches,
                    diplomaBatches: this.data.diplomaBatches,
                    regularBatches: this.data.regularBatches,
                    courses: this.data.courses,
                    teachers: this.data.teachers,
                    rooms: this.data.rooms,
                    routine: this.data.routine,
                    regularRoutine: this.data.regularRoutine,
                    sectionRooms: this.data.sectionRooms,
                    regularBatchRooms: this.data.regularBatchRooms,
                    timeSlots: this.data.timeSlots,
                    regularTimeSlots: this.data.regularTimeSlots,
                    activeBatchType: this.data.activeBatchType,
                    activeBatchConfigTab: this.data.activeBatchConfigTab,
                    currentSemester: this.data.currentSemester
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `class-routine-${this.data.semesterName.replace(/\s+/g, '-')}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                this.autoSave();
                this.showToast('Routine saved successfully!', 'success');
            },

            loadData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const loadedData = JSON.parse(event.target.result);
                                this.data = {
                                    semesterName: loadedData.semesterName || 'Fall 2025',
                                    batches: loadedData.batches || this.data.batches,
                                    diplomaBatches: loadedData.diplomaBatches || this.data.diplomaBatches,
                                    regularBatches: loadedData.regularBatches || this.data.regularBatches,
                                    courses: loadedData.courses || this.data.courses,
                                    teachers: loadedData.teachers || this.data.teachers,
                                    rooms: loadedData.rooms || this.data.rooms,
                                    routine: loadedData.routine || {},
                                    regularRoutine: loadedData.regularRoutine || {},
                                    sectionRooms: loadedData.sectionRooms || {},
                                    regularBatchRooms: loadedData.regularBatchRooms || {},
                                    timeSlots: loadedData.timeSlots || this.data.timeSlots,
                                    regularTimeSlots: loadedData.regularTimeSlots || this.data.regularTimeSlots,
                                    activeBatchType: loadedData.activeBatchType || 'diploma',
                                    activeBatchConfigTab: loadedData.activeBatchConfigTab || 'diploma',
                                    currentSemester: loadedData.currentSemester || 1
                                };
                                localStorage.removeItem('classRoutineData');
                                this.autoSave();
                                this.initRoutine();
                                this.initRegularRoutine();
                                this.renderBatchConfig();
                                this.renderInfoTab();
                                this.renderRoutines();
                                this.renderSidebar();
                                this.renderTeachersSchedule();
                                this.showToast('Routine loaded successfully!', 'success');
                            } catch (error) {
                                this.showToast('Error loading file: Invalid JSON', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                
                input.click();
            },

            exportToPDF() {
                const tabs = document.querySelectorAll('.tab');
                let activeTabIndex = 0;
                tabs.forEach((tab, index) => {
                    if (tab.classList.contains('active')) {
                        activeTabIndex = index;
                    }
                });

                // If on Settings tab (index 3), switch to Class Routine
                // Otherwise, print whichever tab is active
                if (activeTabIndex === 3) {
                    this.switchTab(0);
                }
                
                setTimeout(() => {
                    window.print();
                }, 100);
            },

            clearAll() {
                const batchType = this.data.activeBatchType === 'regular' ? 'Regular' : 'Diploma';
                if (confirm(`Are you sure you want to clear all ${batchType} routine data? This cannot be undone.`)) {
                    if (this.data.activeBatchType === 'regular') {
                        // Clear regular routine data
                        this.data.regularRoutine = {};
                        this.data.regularBatchRooms = {};
                        this.initRegularRoutine();
                    } else {
                        // Clear diploma routine data
                        this.data.routine = {};
                        this.data.sectionRooms = {};
                        this.initRoutine();
                    }
                    this.renderRoutines();
                    this.renderSidebar();
                    this.renderTeachersSchedule();
                    this.autoSave();
                    this.showToast(`All ${batchType} routine data cleared!`, 'success');
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
